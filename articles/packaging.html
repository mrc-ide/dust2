<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Packaging dust systems • dust2</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Packaging dust systems">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">dust2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.28</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/dust2.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/design.html">Principles and design of dust</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Details</h6></li>
    <li><a class="dropdown-item" href="../articles/data.html">Comparing dust systems to data</a></li>
    <li><a class="dropdown-item" href="../articles/details.html">Details</a></li>
    <li><a class="dropdown-item" href="../articles/packaging.html">Packaging dust systems</a></li>
    <li><a class="dropdown-item" href="../articles/periodic.html">Periodic variables details</a></li>
    <li><a class="dropdown-item" href="../articles/writing.html">Writing dust2 systems</a></li>
    <li><a class="dropdown-item" href="../articles/migrating.html">Migrating from dust 1.x.x</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mrc-ide/dust2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Packaging dust systems</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/dust2/blob/main/vignettes/packaging.Rmd" class="external-link"><code>vignettes/packaging.Rmd</code></a></small>
      <div class="d-none name"><code>packaging.Rmd</code></div>
    </div>

    
    
<p>You should not use <code><a href="../reference/dust_compile.html">dust_compile()</a></code> within a package,
because that would cause the model to compile each time you use it,
rather than when the package builds. It may also cause issues when
trying to use the model in parallel (e.g., with the
<code>parallel</code> package), and will require all users of your code
to have a full C++ toolchain. Instead you should use
<code><a href="../reference/dust_package.html">dust_package()</a></code> which will generate appropriate code for
you.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mrc-ide/dust2" class="external-link">dust2</a></span><span class="op">)</span></span></code></pre></div>
<p>To use dust in a package, put your dust source files in
<code>inst/dust</code> and run <code><a href="../reference/dust_package.html">dust_package()</a></code> on the
package’s root directory. You can have several dust systems within a
single package.</p>
<p>A skeleton package might contain:</p>
<pre><code><span><span class="co">#&gt; <span style="color: #0000BB; font-weight: bold;">.</span></span></span>
<span><span class="co">#&gt; ├── DESCRIPTION</span></span>
<span><span class="co">#&gt; ├── NAMESPACE</span></span>
<span><span class="co">#&gt; └── <span style="color: #0000BB; font-weight: bold;">inst</span></span></span>
<span><span class="co">#&gt;     └── <span style="color: #0000BB; font-weight: bold;">dust</span></span></span>
<span><span class="co">#&gt;         └── walk.cpp</span></span></code></pre>
<p>This is the normal R package skeleton, though missing <code>R/</code>
and <code>src/</code> directories (for now). The
<code>DESCRIPTION</code> file contains</p>
<pre class="plain"><code>Package: example
Title: Example Dust in a Package
Version: 0.0.1
Imports: dust2
LinkingTo: cpp11, dust2, monty
Authors@R: c(person('A', 'Person', role = c('aut', 'cre')
                     email = 'person@example.com'))
License: CC0</code></pre>
<p>The important things here are:</p>
<ul>
<li>the package name (<code>Package</code>). We’re using
<code>example</code>, and names with a dot may not work as expected</li>
<li>including <a href="https://github.com/r-lib/cpp11" class="external-link"><code>cpp11</code></a> and
<code>dust</code> in <code>LinkingTo</code>, which allows package
compilation to find their respective header files</li>
<li>a <code>useDynLib</code> call to your package in the
<code>NAMESPACE</code> file</li>
</ul>
<p>Our <code>NAMESPACE</code> file contains:</p>
<pre class="plain"><code><span><span class="fu">useDynLib</span><span class="op">(</span><span class="st">'example'</span>, .registration <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
<p>The files in <code>inst/dust</code> are the same files as seen above,
with <code>walk.cpp</code> containing</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;dust2/common.hpp&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="co">// [[dust2::class(walk)]]</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="co">// [[dust2::time_type(discrete)]]</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="co">// [[dust2::parameter(sd)]]</span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a><span class="kw">class</span> walk <span class="op">{</span></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>  walk<span class="op">()</span> <span class="op">=</span> <span class="kw">delete</span><span class="op">;</span></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">real_type</span> <span class="op">=</span> <span class="dt">double</span><span class="op">;</span></span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a>  <span class="kw">struct</span> shared_state <span class="op">{</span></span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a>    <span class="dt">real_type</span> sd<span class="op">;</span></span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a>  <span class="kw">struct</span> internal_state <span class="op">{};</span></span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">rng_state_type</span> <span class="op">=</span> monty<span class="op">::</span>random<span class="op">::</span>generator<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;;</span></span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a>  <span class="at">static</span> dust2<span class="op">::</span>packing packing_state<span class="op">(</span><span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a>    <span class="cf">return</span> dust2<span class="op">::</span>packing<span class="op">{{</span><span class="st">"x"</span><span class="op">,</span> <span class="op">{}}};</span></span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a>  <span class="at">static</span> shared_state build_shared<span class="op">(</span>cpp11<span class="op">::</span>list pars<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> sd <span class="op">=</span> dust2<span class="op">::</span>r<span class="op">::</span>read_real<span class="op">(</span>pars<span class="op">,</span> <span class="st">"sd"</span><span class="op">);</span></span>
<span id="cb5-26"><a href="#cb5-26" tabindex="-1"></a>    <span class="cf">return</span> shared_state<span class="op">{</span>sd<span class="op">};</span></span>
<span id="cb5-27"><a href="#cb5-27" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-28"><a href="#cb5-28" tabindex="-1"></a></span>
<span id="cb5-29"><a href="#cb5-29" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">void</span> update_shared<span class="op">(</span>cpp11<span class="op">::</span>list pars<span class="op">,</span> shared_state<span class="op">&amp;</span> shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-30"><a href="#cb5-30" tabindex="-1"></a>    shared<span class="op">.</span>sd <span class="op">=</span> dust2<span class="op">::</span>r<span class="op">::</span>read_real<span class="op">(</span>pars<span class="op">,</span> <span class="st">"sd"</span><span class="op">,</span> shared<span class="op">.</span>sd<span class="op">);</span></span>
<span id="cb5-31"><a href="#cb5-31" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-32"><a href="#cb5-32" tabindex="-1"></a></span>
<span id="cb5-33"><a href="#cb5-33" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">void</span> initial<span class="op">(</span><span class="dt">real_type</span> time<span class="op">,</span></span>
<span id="cb5-34"><a href="#cb5-34" tabindex="-1"></a>                      <span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">,</span></span>
<span id="cb5-35"><a href="#cb5-35" tabindex="-1"></a>                      internal_state<span class="op">&amp;</span> internal<span class="op">,</span></span>
<span id="cb5-36"><a href="#cb5-36" tabindex="-1"></a>                      <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">,</span></span>
<span id="cb5-37"><a href="#cb5-37" tabindex="-1"></a>                      <span class="dt">real_type</span> <span class="op">*</span> state_next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-38"><a href="#cb5-38" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb5-39"><a href="#cb5-39" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-40"><a href="#cb5-40" tabindex="-1"></a></span>
<span id="cb5-41"><a href="#cb5-41" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">void</span> update<span class="op">(</span><span class="dt">real_type</span> time<span class="op">,</span></span>
<span id="cb5-42"><a href="#cb5-42" tabindex="-1"></a>                     <span class="dt">real_type</span> dt<span class="op">,</span></span>
<span id="cb5-43"><a href="#cb5-43" tabindex="-1"></a>                     <span class="at">const</span> <span class="dt">real_type</span> <span class="op">*</span> state<span class="op">,</span></span>
<span id="cb5-44"><a href="#cb5-44" tabindex="-1"></a>                     <span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">,</span></span>
<span id="cb5-45"><a href="#cb5-45" tabindex="-1"></a>                     internal_state<span class="op">&amp;</span> internal<span class="op">,</span></span>
<span id="cb5-46"><a href="#cb5-46" tabindex="-1"></a>                     <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">,</span></span>
<span id="cb5-47"><a href="#cb5-47" tabindex="-1"></a>                     <span class="dt">real_type</span> <span class="op">*</span> state_next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-48"><a href="#cb5-48" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> monty<span class="op">::</span>random<span class="op">::</span>normal<span class="op">(</span>rng_state<span class="op">,</span> state<span class="op">[</span><span class="dv">0</span><span class="op">],</span> shared<span class="op">.</span>sd <span class="op">*</span> dt<span class="op">);</span></span>
<span id="cb5-49"><a href="#cb5-49" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-50"><a href="#cb5-50" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>There can be as many of these files as you want within the directory
<code>inst/dust</code>.</p>
<p>To prepare the package, run <code><a href="../reference/dust_package.html">dust_package()</a></code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dust_package.html">dust_package</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Working in package 'example' at '/tmp/Rtmprozceo/file2270d41cf30'</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Found 1 system</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Wrote 'src/walk.cpp'</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Wrote 'R/dust.R'</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Wrote 'src/Makevars'</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> 12 functions decorated with [[cpp11::register]]</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> generated file <span style="color: #0000BB;">cpp11.R</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> generated file <span style="color: #0000BB;">cpp11.cpp</span></span></span></code></pre></div>
<p>The directory structure now has more files:</p>
<pre><code><span><span class="co">#&gt; <span style="color: #0000BB; font-weight: bold;">.</span></span></span>
<span><span class="co">#&gt; ├── DESCRIPTION</span></span>
<span><span class="co">#&gt; ├── NAMESPACE</span></span>
<span><span class="co">#&gt; ├── <span style="color: #0000BB; font-weight: bold;">R</span></span></span>
<span><span class="co">#&gt; │   ├── <span style="color: #00BB00;">cpp11.R</span></span></span>
<span><span class="co">#&gt; │   └── <span style="color: #00BB00;">dust.R</span></span></span>
<span><span class="co">#&gt; ├── <span style="color: #0000BB; font-weight: bold;">inst</span></span></span>
<span><span class="co">#&gt; │   └── <span style="color: #0000BB; font-weight: bold;">dust</span></span></span>
<span><span class="co">#&gt; │       └── walk.cpp</span></span>
<span><span class="co">#&gt; └── <span style="color: #0000BB; font-weight: bold;">src</span></span></span>
<span><span class="co">#&gt;     ├── Makevars</span></span>
<span><span class="co">#&gt;     ├── cpp11.cpp</span></span>
<span><span class="co">#&gt;     └── walk.cpp</span></span></code></pre>
<p>The file <code>src/walk.cpp</code> is generated by dust and should
not be edited. They include your model, but also a bit of helper
code:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="co">// Generated by dust2 (version 0.3.28) - do not edit</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;dust2/common.hpp&gt;</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a><span class="co">// [[dust2::class(walk)]]</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a><span class="co">// [[dust2::time_type(discrete)]]</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a><span class="co">// [[dust2::parameter(sd)]]</span></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a><span class="kw">class</span> walk <span class="op">{</span></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>  walk<span class="op">()</span> <span class="op">=</span> <span class="kw">delete</span><span class="op">;</span></span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">real_type</span> <span class="op">=</span> <span class="dt">double</span><span class="op">;</span></span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a>  <span class="kw">struct</span> shared_state <span class="op">{</span></span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a>    <span class="dt">real_type</span> sd<span class="op">;</span></span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a>  <span class="kw">struct</span> internal_state <span class="op">{};</span></span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">rng_state_type</span> <span class="op">=</span> monty<span class="op">::</span>random<span class="op">::</span>generator<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;;</span></span>
<span id="cb8-21"><a href="#cb8-21" tabindex="-1"></a></span>
<span id="cb8-22"><a href="#cb8-22" tabindex="-1"></a>  <span class="at">static</span> dust2<span class="op">::</span>packing packing_state<span class="op">(</span><span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-23"><a href="#cb8-23" tabindex="-1"></a>    <span class="cf">return</span> dust2<span class="op">::</span>packing<span class="op">{{</span><span class="st">"x"</span><span class="op">,</span> <span class="op">{}}};</span></span>
<span id="cb8-24"><a href="#cb8-24" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb8-25"><a href="#cb8-25" tabindex="-1"></a></span>
<span id="cb8-26"><a href="#cb8-26" tabindex="-1"></a>  <span class="at">static</span> shared_state build_shared<span class="op">(</span>cpp11<span class="op">::</span>list pars<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-27"><a href="#cb8-27" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> sd <span class="op">=</span> dust2<span class="op">::</span>r<span class="op">::</span>read_real<span class="op">(</span>pars<span class="op">,</span> <span class="st">"sd"</span><span class="op">);</span></span>
<span id="cb8-28"><a href="#cb8-28" tabindex="-1"></a>    <span class="cf">return</span> shared_state<span class="op">{</span>sd<span class="op">};</span></span>
<span id="cb8-29"><a href="#cb8-29" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb8-30"><a href="#cb8-30" tabindex="-1"></a></span>
<span id="cb8-31"><a href="#cb8-31" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">void</span> update_shared<span class="op">(</span>cpp11<span class="op">::</span>list pars<span class="op">,</span> shared_state<span class="op">&amp;</span> shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-32"><a href="#cb8-32" tabindex="-1"></a>    shared<span class="op">.</span>sd <span class="op">=</span> dust2<span class="op">::</span>r<span class="op">::</span>read_real<span class="op">(</span>pars<span class="op">,</span> <span class="st">"sd"</span><span class="op">,</span> shared<span class="op">.</span>sd<span class="op">);</span></span>
<span id="cb8-33"><a href="#cb8-33" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb8-34"><a href="#cb8-34" tabindex="-1"></a></span>
<span id="cb8-35"><a href="#cb8-35" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">void</span> initial<span class="op">(</span><span class="dt">real_type</span> time<span class="op">,</span></span>
<span id="cb8-36"><a href="#cb8-36" tabindex="-1"></a>                      <span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">,</span></span>
<span id="cb8-37"><a href="#cb8-37" tabindex="-1"></a>                      internal_state<span class="op">&amp;</span> internal<span class="op">,</span></span>
<span id="cb8-38"><a href="#cb8-38" tabindex="-1"></a>                      <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">,</span></span>
<span id="cb8-39"><a href="#cb8-39" tabindex="-1"></a>                      <span class="dt">real_type</span> <span class="op">*</span> state_next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-40"><a href="#cb8-40" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb8-41"><a href="#cb8-41" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb8-42"><a href="#cb8-42" tabindex="-1"></a></span>
<span id="cb8-43"><a href="#cb8-43" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">void</span> update<span class="op">(</span><span class="dt">real_type</span> time<span class="op">,</span></span>
<span id="cb8-44"><a href="#cb8-44" tabindex="-1"></a>                     <span class="dt">real_type</span> dt<span class="op">,</span></span>
<span id="cb8-45"><a href="#cb8-45" tabindex="-1"></a>                     <span class="at">const</span> <span class="dt">real_type</span> <span class="op">*</span> state<span class="op">,</span></span>
<span id="cb8-46"><a href="#cb8-46" tabindex="-1"></a>                     <span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">,</span></span>
<span id="cb8-47"><a href="#cb8-47" tabindex="-1"></a>                     internal_state<span class="op">&amp;</span> internal<span class="op">,</span></span>
<span id="cb8-48"><a href="#cb8-48" tabindex="-1"></a>                     <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">,</span></span>
<span id="cb8-49"><a href="#cb8-49" tabindex="-1"></a>                     <span class="dt">real_type</span> <span class="op">*</span> state_next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-50"><a href="#cb8-50" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> monty<span class="op">::</span>random<span class="op">::</span>normal<span class="op">(</span>rng_state<span class="op">,</span> state<span class="op">[</span><span class="dv">0</span><span class="op">],</span> shared<span class="op">.</span>sd <span class="op">*</span> dt<span class="op">);</span></span>
<span id="cb8-51"><a href="#cb8-51" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb8-52"><a href="#cb8-52" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb8-53"><a href="#cb8-53" tabindex="-1"></a></span>
<span id="cb8-54"><a href="#cb8-54" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cpp11.hpp&gt;</span></span>
<span id="cb8-55"><a href="#cb8-55" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;dust2/r/discrete/system.hpp&gt;</span></span>
<span id="cb8-56"><a href="#cb8-56" tabindex="-1"></a></span>
<span id="cb8-57"><a href="#cb8-57" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb8-58"><a href="#cb8-58" tabindex="-1"></a>SEXP dust2_system_walk_alloc<span class="op">(</span>cpp11<span class="op">::</span>list r_pars<span class="op">,</span> cpp11<span class="op">::</span>sexp r_time<span class="op">,</span> cpp11<span class="op">::</span>list r_time_control<span class="op">,</span> cpp11<span class="op">::</span>sexp r_n_particles<span class="op">,</span> cpp11<span class="op">::</span>sexp r_n_groups<span class="op">,</span> cpp11<span class="op">::</span>sexp r_seed<span class="op">,</span> cpp11<span class="op">::</span>sexp r_deterministic<span class="op">,</span> cpp11<span class="op">::</span>sexp r_n_threads<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-59"><a href="#cb8-59" tabindex="-1"></a>  <span class="cf">return</span> dust2<span class="op">::</span>r<span class="op">::</span>dust2_discrete_alloc<span class="op">&lt;</span>walk<span class="op">&gt;(</span>r_pars<span class="op">,</span> r_time<span class="op">,</span> r_time_control<span class="op">,</span> r_n_particles<span class="op">,</span> r_n_groups<span class="op">,</span> r_seed<span class="op">,</span> r_deterministic<span class="op">,</span> r_n_threads<span class="op">);</span></span>
<span id="cb8-60"><a href="#cb8-60" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-61"><a href="#cb8-61" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb8-62"><a href="#cb8-62" tabindex="-1"></a>SEXP dust2_system_walk_run_to_time<span class="op">(</span>cpp11<span class="op">::</span>sexp ptr<span class="op">,</span> cpp11<span class="op">::</span>sexp r_time<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-63"><a href="#cb8-63" tabindex="-1"></a>  <span class="cf">return</span> dust2<span class="op">::</span>r<span class="op">::</span>dust2_system_run_to_time<span class="op">&lt;</span>dust2<span class="op">::</span>dust_discrete<span class="op">&lt;</span>walk<span class="op">&gt;&gt;(</span>ptr<span class="op">,</span> r_time<span class="op">);</span></span>
<span id="cb8-64"><a href="#cb8-64" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-65"><a href="#cb8-65" tabindex="-1"></a></span>
<span id="cb8-66"><a href="#cb8-66" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb8-67"><a href="#cb8-67" tabindex="-1"></a>SEXP dust2_system_walk_state<span class="op">(</span>cpp11<span class="op">::</span>sexp ptr<span class="op">,</span> cpp11<span class="op">::</span>sexp r_index_state<span class="op">,</span> cpp11<span class="op">::</span>sexp r_index_particle<span class="op">,</span> cpp11<span class="op">::</span>sexp r_index_group<span class="op">,</span> <span class="dt">bool</span> preserve_particle_dimension<span class="op">,</span> <span class="dt">bool</span> preserve_group_dimension<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-68"><a href="#cb8-68" tabindex="-1"></a>  <span class="cf">return</span> dust2<span class="op">::</span>r<span class="op">::</span>dust2_system_state<span class="op">&lt;</span>dust2<span class="op">::</span>dust_discrete<span class="op">&lt;</span>walk<span class="op">&gt;&gt;(</span>ptr<span class="op">,</span> r_index_state<span class="op">,</span> r_index_particle<span class="op">,</span> r_index_group<span class="op">,</span> preserve_particle_dimension<span class="op">,</span> preserve_group_dimension<span class="op">);</span></span>
<span id="cb8-69"><a href="#cb8-69" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-70"><a href="#cb8-70" tabindex="-1"></a></span>
<span id="cb8-71"><a href="#cb8-71" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb8-72"><a href="#cb8-72" tabindex="-1"></a>SEXP dust2_system_walk_time<span class="op">(</span>cpp11<span class="op">::</span>sexp ptr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-73"><a href="#cb8-73" tabindex="-1"></a>  <span class="cf">return</span> dust2<span class="op">::</span>r<span class="op">::</span>dust2_system_time<span class="op">&lt;</span>dust2<span class="op">::</span>dust_discrete<span class="op">&lt;</span>walk<span class="op">&gt;&gt;(</span>ptr<span class="op">);</span></span>
<span id="cb8-74"><a href="#cb8-74" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-75"><a href="#cb8-75" tabindex="-1"></a></span>
<span id="cb8-76"><a href="#cb8-76" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb8-77"><a href="#cb8-77" tabindex="-1"></a>SEXP dust2_system_walk_set_state_initial<span class="op">(</span>cpp11<span class="op">::</span>sexp ptr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-78"><a href="#cb8-78" tabindex="-1"></a>  <span class="cf">return</span> dust2<span class="op">::</span>r<span class="op">::</span>dust2_system_set_state_initial<span class="op">&lt;</span>dust2<span class="op">::</span>dust_discrete<span class="op">&lt;</span>walk<span class="op">&gt;&gt;(</span>ptr<span class="op">);</span></span>
<span id="cb8-79"><a href="#cb8-79" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-80"><a href="#cb8-80" tabindex="-1"></a></span>
<span id="cb8-81"><a href="#cb8-81" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb8-82"><a href="#cb8-82" tabindex="-1"></a>SEXP dust2_system_walk_set_state<span class="op">(</span>cpp11<span class="op">::</span>sexp ptr<span class="op">,</span> cpp11<span class="op">::</span>list r_state<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-83"><a href="#cb8-83" tabindex="-1"></a>  <span class="cf">return</span> dust2<span class="op">::</span>r<span class="op">::</span>dust2_system_set_state<span class="op">&lt;</span>dust2<span class="op">::</span>dust_discrete<span class="op">&lt;</span>walk<span class="op">&gt;&gt;(</span>ptr<span class="op">,</span> r_state<span class="op">);</span></span>
<span id="cb8-84"><a href="#cb8-84" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-85"><a href="#cb8-85" tabindex="-1"></a></span>
<span id="cb8-86"><a href="#cb8-86" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb8-87"><a href="#cb8-87" tabindex="-1"></a>SEXP dust2_system_walk_reorder<span class="op">(</span>cpp11<span class="op">::</span>sexp ptr<span class="op">,</span> cpp11<span class="op">::</span>integers r_index<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-88"><a href="#cb8-88" tabindex="-1"></a>  <span class="cf">return</span> dust2<span class="op">::</span>r<span class="op">::</span>dust2_system_reorder<span class="op">&lt;</span>dust2<span class="op">::</span>dust_discrete<span class="op">&lt;</span>walk<span class="op">&gt;&gt;(</span>ptr<span class="op">,</span> r_index<span class="op">);</span></span>
<span id="cb8-89"><a href="#cb8-89" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-90"><a href="#cb8-90" tabindex="-1"></a></span>
<span id="cb8-91"><a href="#cb8-91" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb8-92"><a href="#cb8-92" tabindex="-1"></a>SEXP dust2_system_walk_rng_state<span class="op">(</span>cpp11<span class="op">::</span>sexp ptr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-93"><a href="#cb8-93" tabindex="-1"></a>  <span class="cf">return</span> dust2<span class="op">::</span>r<span class="op">::</span>dust2_system_rng_state<span class="op">&lt;</span>dust2<span class="op">::</span>dust_discrete<span class="op">&lt;</span>walk<span class="op">&gt;&gt;(</span>ptr<span class="op">);</span></span>
<span id="cb8-94"><a href="#cb8-94" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-95"><a href="#cb8-95" tabindex="-1"></a></span>
<span id="cb8-96"><a href="#cb8-96" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb8-97"><a href="#cb8-97" tabindex="-1"></a>SEXP dust2_system_walk_set_rng_state<span class="op">(</span>cpp11<span class="op">::</span>sexp ptr<span class="op">,</span> cpp11<span class="op">::</span>sexp r_rng_state<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-98"><a href="#cb8-98" tabindex="-1"></a>  <span class="cf">return</span> dust2<span class="op">::</span>r<span class="op">::</span>dust2_system_set_rng_state<span class="op">&lt;</span>dust2<span class="op">::</span>dust_discrete<span class="op">&lt;</span>walk<span class="op">&gt;&gt;(</span>ptr<span class="op">,</span> r_rng_state<span class="op">);</span></span>
<span id="cb8-99"><a href="#cb8-99" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-100"><a href="#cb8-100" tabindex="-1"></a></span>
<span id="cb8-101"><a href="#cb8-101" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb8-102"><a href="#cb8-102" tabindex="-1"></a>SEXP dust2_system_walk_set_time<span class="op">(</span>cpp11<span class="op">::</span>sexp ptr<span class="op">,</span> cpp11<span class="op">::</span>sexp r_time<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-103"><a href="#cb8-103" tabindex="-1"></a>  <span class="cf">return</span> dust2<span class="op">::</span>r<span class="op">::</span>dust2_system_set_time<span class="op">&lt;</span>dust2<span class="op">::</span>dust_discrete<span class="op">&lt;</span>walk<span class="op">&gt;&gt;(</span>ptr<span class="op">,</span> r_time<span class="op">);</span></span>
<span id="cb8-104"><a href="#cb8-104" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-105"><a href="#cb8-105" tabindex="-1"></a></span>
<span id="cb8-106"><a href="#cb8-106" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb8-107"><a href="#cb8-107" tabindex="-1"></a>SEXP dust2_system_walk_update_pars<span class="op">(</span>cpp11<span class="op">::</span>sexp ptr<span class="op">,</span> cpp11<span class="op">::</span>list pars<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-108"><a href="#cb8-108" tabindex="-1"></a>  <span class="cf">return</span> dust2<span class="op">::</span>r<span class="op">::</span>dust2_system_update_pars<span class="op">&lt;</span>dust2<span class="op">::</span>dust_discrete<span class="op">&lt;</span>walk<span class="op">&gt;&gt;(</span>ptr<span class="op">,</span> pars<span class="op">);</span></span>
<span id="cb8-109"><a href="#cb8-109" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-110"><a href="#cb8-110" tabindex="-1"></a></span>
<span id="cb8-111"><a href="#cb8-111" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb8-112"><a href="#cb8-112" tabindex="-1"></a>SEXP dust2_system_walk_simulate<span class="op">(</span>cpp11<span class="op">::</span>sexp ptr<span class="op">,</span> cpp11<span class="op">::</span>sexp r_times<span class="op">,</span> cpp11<span class="op">::</span>sexp r_index_state<span class="op">,</span> <span class="dt">bool</span> preserve_particle_dimension<span class="op">,</span> <span class="dt">bool</span> preserve_group_dimension<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-113"><a href="#cb8-113" tabindex="-1"></a>  <span class="cf">return</span> dust2<span class="op">::</span>r<span class="op">::</span>dust2_system_simulate<span class="op">&lt;</span>dust2<span class="op">::</span>dust_discrete<span class="op">&lt;</span>walk<span class="op">&gt;&gt;(</span>ptr<span class="op">,</span> r_times<span class="op">,</span> r_index_state<span class="op">,</span> preserve_particle_dimension<span class="op">,</span> preserve_group_dimension<span class="op">);</span></span>
<span id="cb8-114"><a href="#cb8-114" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The file <code>R/dust.R</code> contains the R interface generated by
dust with the constructor objects (all models’ constructors will be
collected into this file, which also should not be edited).</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Generated by dust2 (version 0.3.28) - do not edit</span></span>
<span><span class="va">walk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="st">"walk"</span><span class="op">)</span>,</span>
<span>  class <span class="op">=</span> <span class="st">"dust_system_generator"</span>,</span>
<span>  name <span class="op">=</span> <span class="st">"walk"</span>,</span>
<span>  package <span class="op">=</span> <span class="st">"example"</span>,</span>
<span>  path <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="st">"sd"</span>,</span>
<span>    type <span class="op">=</span> <span class="st">"real_type"</span><span class="op">)</span>,</span>
<span>  properties <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    time_type <span class="op">=</span> <span class="st">"discrete"</span>,</span>
<span>    has_compare <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    has_adjoint <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  default_dt <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>Finally, <code>R/cpp11.R</code> and <code>src/cpp11.cpp</code> are
files created by cpp11 that should not be edited.</p>
<p>Your package can include as much R code as you want, and can be
developed like any other R package. But any time you change the code in
<code>inst/dust</code> you should rerun <code><a href="../reference/dust_package.html">dust_package()</a></code>.</p>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Rich FitzJohn.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>

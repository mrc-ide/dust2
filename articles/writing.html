<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Writing dust2 systems • dust2</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Writing dust2 systems">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">dust2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.28</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/dust2.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/design.html">Principles and design of dust</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Details</h6></li>
    <li><a class="dropdown-item" href="../articles/data.html">Comparing dust systems to data</a></li>
    <li><a class="dropdown-item" href="../articles/details.html">Details</a></li>
    <li><a class="dropdown-item" href="../articles/packaging.html">Packaging dust systems</a></li>
    <li><a class="dropdown-item" href="../articles/periodic.html">Periodic variables details</a></li>
    <li><a class="dropdown-item" href="../articles/writing.html">Writing dust2 systems</a></li>
    <li><a class="dropdown-item" href="../articles/migrating.html">Migrating from dust 1.x.x</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mrc-ide/dust2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Writing dust2 systems</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/dust2/blob/main/vignettes/writing.Rmd" class="external-link"><code>vignettes/writing.Rmd</code></a></small>
      <div class="d-none name"><code>writing.Rmd</code></div>
    </div>

    
    
<p>This vignette covers how to write <code>dust2</code> systems from
scratch. Users of this package via <a href="https://mrc-ide.github.io/odin2" class="external-link"><code>odin2</code></a> do not
need to read or understand this vignette, though of course you are
welcome to read it. We will start with an almost comically trivial
system and try to expand it over several sections.</p>
<div class="section level2">
<h2 id="first-steps-a-random-walk">First steps, a random walk<a class="anchor" aria-label="anchor" href="#first-steps-a-random-walk"></a>
</h2>
<p>Consider a unbiased random walk; at each time step we move our
position with a draw from a normal distribution with mean 0 and some
standard deviation.</p>
<p>To implement this model in dust we write out a C++ file that looks
like:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;dust2/common.hpp&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="co">// [[dust2::class(walk)]]</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="co">// [[dust2::time_type(discrete)]]</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="co">// [[dust2::parameter(sd)]]</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="kw">class</span> walk <span class="op">{</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a>  walk<span class="op">()</span> <span class="op">=</span> <span class="kw">delete</span><span class="op">;</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">real_type</span> <span class="op">=</span> <span class="dt">double</span><span class="op">;</span></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a>  <span class="kw">struct</span> shared_state <span class="op">{</span></span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a>    <span class="dt">real_type</span> sd<span class="op">;</span></span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a>  <span class="kw">struct</span> internal_state <span class="op">{};</span></span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">rng_state_type</span> <span class="op">=</span> monty<span class="op">::</span>random<span class="op">::</span>generator<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;;</span></span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a>  <span class="at">static</span> dust2<span class="op">::</span>packing packing_state<span class="op">(</span><span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a>    <span class="cf">return</span> dust2<span class="op">::</span>packing<span class="op">{{</span><span class="st">"x"</span><span class="op">,</span> <span class="op">{}}};</span></span>
<span id="cb1-22"><a href="#cb1-22" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb1-23"><a href="#cb1-23" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" tabindex="-1"></a>  <span class="at">static</span> shared_state build_shared<span class="op">(</span>cpp11<span class="op">::</span>list pars<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-25"><a href="#cb1-25" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> sd <span class="op">=</span> dust2<span class="op">::</span>r<span class="op">::</span>read_real<span class="op">(</span>pars<span class="op">,</span> <span class="st">"sd"</span><span class="op">);</span></span>
<span id="cb1-26"><a href="#cb1-26" tabindex="-1"></a>    <span class="cf">return</span> shared_state<span class="op">{</span>sd<span class="op">};</span></span>
<span id="cb1-27"><a href="#cb1-27" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb1-28"><a href="#cb1-28" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">void</span> update_shared<span class="op">(</span>cpp11<span class="op">::</span>list pars<span class="op">,</span> shared_state<span class="op">&amp;</span> shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-30"><a href="#cb1-30" tabindex="-1"></a>    shared<span class="op">.</span>sd <span class="op">=</span> dust2<span class="op">::</span>r<span class="op">::</span>read_real<span class="op">(</span>pars<span class="op">,</span> <span class="st">"sd"</span><span class="op">,</span> shared<span class="op">.</span>sd<span class="op">);</span></span>
<span id="cb1-31"><a href="#cb1-31" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb1-32"><a href="#cb1-32" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">void</span> initial<span class="op">(</span><span class="dt">real_type</span> time<span class="op">,</span></span>
<span id="cb1-34"><a href="#cb1-34" tabindex="-1"></a>                      <span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">,</span></span>
<span id="cb1-35"><a href="#cb1-35" tabindex="-1"></a>                      internal_state<span class="op">&amp;</span> internal<span class="op">,</span></span>
<span id="cb1-36"><a href="#cb1-36" tabindex="-1"></a>                      <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">,</span></span>
<span id="cb1-37"><a href="#cb1-37" tabindex="-1"></a>                      <span class="dt">real_type</span> <span class="op">*</span> state_next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-38"><a href="#cb1-38" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-39"><a href="#cb1-39" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb1-40"><a href="#cb1-40" tabindex="-1"></a></span>
<span id="cb1-41"><a href="#cb1-41" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">void</span> update<span class="op">(</span><span class="dt">real_type</span> time<span class="op">,</span></span>
<span id="cb1-42"><a href="#cb1-42" tabindex="-1"></a>                     <span class="dt">real_type</span> dt<span class="op">,</span></span>
<span id="cb1-43"><a href="#cb1-43" tabindex="-1"></a>                     <span class="at">const</span> <span class="dt">real_type</span> <span class="op">*</span> state<span class="op">,</span></span>
<span id="cb1-44"><a href="#cb1-44" tabindex="-1"></a>                     <span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">,</span></span>
<span id="cb1-45"><a href="#cb1-45" tabindex="-1"></a>                     internal_state<span class="op">&amp;</span> internal<span class="op">,</span></span>
<span id="cb1-46"><a href="#cb1-46" tabindex="-1"></a>                     <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">,</span></span>
<span id="cb1-47"><a href="#cb1-47" tabindex="-1"></a>                     <span class="dt">real_type</span> <span class="op">*</span> state_next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-48"><a href="#cb1-48" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> monty<span class="op">::</span>random<span class="op">::</span>normal<span class="op">(</span>rng_state<span class="op">,</span> state<span class="op">[</span><span class="dv">0</span><span class="op">],</span> shared<span class="op">.</span>sd <span class="op">*</span> dt<span class="op">);</span></span>
<span id="cb1-49"><a href="#cb1-49" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb1-50"><a href="#cb1-50" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>All the code sits inside a class, though in this class every method
is <code>static</code> (we have deleted the constructor by writing
<code>walk() = delete;</code> to emphasise this). All dust class
definitions have the same components, but the order is not terribly
important:</p>
<ul>
<li>a series of annotations (the comments starting with
<code>// [[dust2::</code>)</li>
<li>some type declarations and <code>struct</code> definitions</li>
<li>a series of <code>static</code> methods. For these, the types of the
arguments must match the interface described here</li>
</ul>
<p>We consider each of these pieces in turn here, and consider the
<em>other</em> values that might have been used in place.</p>
<div class="section level3">
<h3 id="support-code">Support code<a class="anchor" aria-label="anchor" href="#support-code"></a>
</h3>
<p>We include a header from <code>dust2</code>; the path for the
compiler to find this will be arranged by R using its
<code>LinkingTo</code> system. This include must be present.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;dust2/common.hpp&gt;</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="annotations">Annotations<a class="anchor" aria-label="anchor" href="#annotations"></a>
</h3>
<p>The first annotation tells <code>dust2</code> the name of the class
that contains the system definition. This may seem obvious but computers
are actually not very clever and it’s best to be blunt with them.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co">// [[dust2::class(walk)]]</span></span></code></pre></div>
<p>The second annotation tells <code>dust2</code> that this is a
discrete-time (as opposed to continuous time) system:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co">// [[dust2::time_type(discrete)]]</span></span></code></pre></div>
<p>If we had wanted a continuous time system of ODEs we would have
instead written:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co">// [[dust2::time_type(continuous)]]</span></span></code></pre></div>
<p>and then later some of the rest of the code would be different; we
will discuss this later.</p>
<p>The remaining annotations tell <code>dust2</code> about the
parameters. We use these to help communicate with the users of the
system the inputs that generator accepts. These are really
<em>documentation</em> rather than controlling how parameters are
processed in the <code>build_shared</code> and
<code>update_shared</code> methods described below, and it is up to you
to keep them in sync. If you prefer, these could go directly above the
code that handles each parameter. This information is surfaced to R via
the <code>print</code> and <code>coef</code> methods of the generator
and system objects.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co">// [[dust2::parameter(sd)]]</span></span></code></pre></div>
<p>The other annotations that we did not use here are</p>
<ul>
<li>
<code>// [[dust2::name(&lt;value&gt;)]]</code> - specify a different
name in R for your system to the class name</li>
<li>
<code>// [[dust2::default_dt(&lt;value&gt;)]]</code> - specify a
default value for <code>dt</code>
</li>
<li>
<code>// [[dust2::has_compare()]]</code> - required to support
comparison to data</li>
<li>
<code>// [[dust2::has_adjoint()]]</code> - required to support
likelihood gradients</li>
</ul>
<p>We will describe these later.</p>
</div>
<div class="section level3">
<h3 id="type-definitions">Type definitions<a class="anchor" aria-label="anchor" href="#type-definitions"></a>
</h3>
<p>The first type we need is one for the real type (<em>we might change
this, depending on how rewriting the currently-absent GPU interface
goes</em>). But for now at least you must include this line and it’s
best if it is exactly as is written here.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">real_type</span> <span class="op">=</span> <span class="dt">double</span><span class="op">;</span></span></code></pre></div>
<p>If you have come from a C background, this <code>using</code>
statement is a lot like writing <code>typedef double real_type;</code>
except that the arguments go the other way around and it contains an
equals sign.</p>
<p>Second, we have the <strong>shared state</strong>:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>  <span class="kw">struct</span> shared_state <span class="op">{</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>    <span class="dt">real_type</span> sd<span class="op">;</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>  <span class="op">};</span></span></code></pre></div>
<p>Values in <code>shared_state</code> are quantities, often parameters,
that do not vary after a system is initialised (or after running
<code><a href="../reference/dust_system_update_pars.html">dust_system_update_pars()</a></code>) and which are shared across all
particles in a group. They are read-only while the system is running
(indeed through all the non-parameter methods below). You can include
derived quantities here too. In this model we have one element,
<code>sd</code>, which will represent the standard deviation of the
random walk over a time unit.</p>
<p>Third, we have an empty <strong>internal state</strong>:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>  <span class="kw">struct</span> internal_state <span class="op">{};</span></span></code></pre></div>
<p>Internal state is particle-specific state that can be used as scratch
space that a particle can read and write to as it evaluates but which is
not tied to a specific particle.</p>
<p>Finally, we have the <strong>random number state</strong>:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">rng_state_type</span> <span class="op">=</span> monty<span class="op">::</span>random<span class="op">::</span>generator<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;;</span></span></code></pre></div>
<p>As with <code>real_type</code> above, this was designed for
flexibility in dust version 1 that we may not need here, so it may
change in future. However, we do need a convenient name for this type,
so it is best left as is.</p>
</div>
<div class="section level3">
<h3 id="the-methods">The methods<a class="anchor" aria-label="anchor" href="#the-methods"></a>
</h3>
<p>First up, we describe how state is packed. Here we have a single
compartment <code>x</code>, which is a scalar. This is described in the
packing as:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>  <span class="at">static</span> dust2<span class="op">::</span>packing packing_state<span class="op">(</span><span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>    <span class="cf">return</span> dust2<span class="op">::</span>packing<span class="op">{{</span><span class="st">"x"</span><span class="op">,</span> <span class="op">{}}};</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>The <code><a href="https://rdrr.io/r/base/Paren.html" class="external-link">{}</a></code> here indicates <code>x</code> is a scalar. If it
had been a vector the length would be within the braces (e.g.,
<code>{3}</code> or <code>{shared.len}</code>) and if it had been a
matrix there would be two elements. We’ll describe this more fully
later.</p>
<p>Next, we have <code>build_shared</code>, which takes an R list
(<code>cpp11::list</code>) and converts it into our
<code>shared_state</code> type. The implementation here can be whatever
you fancy.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>  <span class="at">static</span> shared_state build_shared<span class="op">(</span>cpp11<span class="op">::</span>list pars<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> sd <span class="op">=</span> dust2<span class="op">::</span>r<span class="op">::</span>read_real<span class="op">(</span>pars<span class="op">,</span> <span class="st">"sd"</span><span class="op">);</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>    <span class="cf">return</span> shared_state<span class="op">{</span>sd<span class="op">};</span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>Here, we have used a dust convenience function
<code>dust2::r::read_real</code> to convert the R element
<code>sd</code> from <code>pars</code> into a real and then construct
the <code>struct</code> from that. We might have written this manually
as something like:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>  <span class="at">static</span> shared_state build_shared<span class="op">(</span>cpp11<span class="op">::</span>list pars<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>    <span class="dt">real_type</span> sd <span class="op">=</span> cpp11<span class="op">::</span>as_cpp<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>pars<span class="op">[</span><span class="st">"sd"</span><span class="op">]);</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>    <span class="cf">return</span> shared_state<span class="op">{</span>sd<span class="op">};</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>but we find that the <code>cpp11</code> conversion functions produce
error messages that are hard to action; if our list <code>pars</code>
does not have an element <code>sd</code>, the <em>name</em>
<code>sd</code> does not occur within the error message so the user does
not really know what has gone wrong.</p>
<p>The first sort of interesting method is <code>initial</code>, which
computes initial conditions for our system. Though in this case it’s
trivial so it’s not terribly interesting:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">void</span> initial<span class="op">(</span><span class="dt">real_type</span> time<span class="op">,</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>                      <span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">,</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>                      internal_state<span class="op">&amp;</span> internal<span class="op">,</span></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>                      <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">,</span></span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>                      <span class="dt">real_type</span> <span class="op">*</span> state_next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>This function takes as argument:</p>
<ul>
<li>
<code>time</code>, which is the time at which the system is being
initialised. Our initial conditions don’t depend on time so we will
ignore this, but some systems will find it useful.</li>
<li>
<code>shared</code>, a <strong>read only</strong>
(<code>const</code>) reference to our shared data (in this system a
<code>struct</code> containing <code>sd</code>). We will ignore this as
well.</li>
<li>
<code>internal</code>, a mutable reference to our internal state,
which is an empty <code>struct</code>. We ignore this as well.</li>
<li>
<code>rng_state</code>, the state of the random number generator for
this particle; we would use this to generate random numbers if we did
so, which we don’t, so you will be unsurprised to read that we ignore
this one too.</li>
<li>
<code>state_next</code>, the system state that we are initialising.
This one we will write to, and it will contain on exit the initial
conditions.</li>
</ul>
<p>Note that <code>state_next</code> is a raw pointer, which is a bit
gross if you are used to modern C++, but here we are writing into the
middle of a big state vector that includes all our particles. It is your
responsibility not to write past the end of this (here we can write
exactly one number but in complex systems the state for each particle
could be quite long). If we used C++20 we might have used <a href="https://en.cppreference.com/w/cpp/ranges" class="external-link">ranges support</a> to do
this more nicely.</p>
<p>The actual implementation is trivial; we zero the initial
condition!</p>
<p>And finally we have the <code>update</code> method, which will
usually be the bulk of a system implementation:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">void</span> update<span class="op">(</span><span class="dt">real_type</span> time<span class="op">,</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>                     <span class="dt">real_type</span> dt<span class="op">,</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>                     <span class="at">const</span> <span class="dt">real_type</span> <span class="op">*</span> state<span class="op">,</span></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>                     <span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">,</span></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>                     internal_state<span class="op">&amp;</span> internal<span class="op">,</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>                     <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">,</span></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>                     <span class="dt">real_type</span> <span class="op">*</span> state_next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> monty<span class="op">::</span>random<span class="op">::</span>normal<span class="op">(</span>rng_state<span class="op">,</span> state<span class="op">[</span><span class="dv">0</span><span class="op">],</span> shared<span class="op">.</span>sd <span class="op">*</span> dt<span class="op">);</span></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>As with <code>initial</code> there are quite a few arguments:</p>
<ul>
<li>
<code>time</code>, as for <code>initial</code> the time at the
<strong>start</strong> of the step</li>
<li>
<code>dt</code>, the size of the time step (so we will move to
<code>time + dt</code>)</li>
<li>
<code>state</code>, a <strong>read-only</strong>
(<code>const</code>) pointer to the state at the start of the step</li>
<li>
<code>shared</code>, <code>internal</code> and
<code>rng_state</code>, as for <code>initial</code>
</li>
<li>
<code>state_next</code>, a mutable pointer to the state at the end
of the step.</li>
</ul>
<p>The general pattern is to read variables from <code>state</code>, do
some calculations and write to <code>state_next</code>, which is what we
do here. We use the <code>monty</code> random library to sample from a
normal distribution, referencing the previous state
<code>state[0]</code>, using the standard deviation of the process from
<code>shared_state</code> (<code>shared.sd</code>) scaled by
<code>dt</code> and using the random number state
<code>rng_state</code>, writing this back into
<code>state_next</code>.</p>
</div>
</div>
<div class="section level2">
<h2 id="multiple-variables-the-sir-revisited">Multiple variables, the SIR revisited<a class="anchor" aria-label="anchor" href="#multiple-variables-the-sir-revisited"></a>
</h2>
<p>Slightly more interestingly, consider the SIR model used elsewhere in
the docs (<code>dust_example("sir")</code> and elsewhere). Here, we’ll
show a minimal implementation of this, which shows off a few more
features:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;dust2/common.hpp&gt;</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a><span class="co">// [[dust2::class(sir)]]</span></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a><span class="co">// [[dust2::time_type(discrete)]]</span></span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a><span class="co">// [[dust2::has_compare()]]</span></span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a><span class="co">// [[dust2::parameter(I0, constant = FALSE)]]</span></span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a><span class="co">// [[dust2::parameter(N, constant = TRUE)]]</span></span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a><span class="co">// [[dust2::parameter(beta, constant = FALSE)]]</span></span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a><span class="co">// [[dust2::parameter(gamma, constant = FALSE)]]</span></span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a><span class="co">// [[dust2::parameter(exp_noise, constant = TRUE)]]</span></span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a><span class="kw">class</span> sir <span class="op">{</span></span>
<span id="cb16-12"><a href="#cb16-12" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb16-13"><a href="#cb16-13" tabindex="-1"></a>  sir<span class="op">()</span> <span class="op">=</span> <span class="kw">delete</span><span class="op">;</span></span>
<span id="cb16-14"><a href="#cb16-14" tabindex="-1"></a></span>
<span id="cb16-15"><a href="#cb16-15" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">real_type</span> <span class="op">=</span> <span class="dt">double</span><span class="op">;</span></span>
<span id="cb16-16"><a href="#cb16-16" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" tabindex="-1"></a>  <span class="kw">struct</span> shared_state <span class="op">{</span></span>
<span id="cb16-18"><a href="#cb16-18" tabindex="-1"></a>    <span class="dt">real_type</span> N<span class="op">;</span></span>
<span id="cb16-19"><a href="#cb16-19" tabindex="-1"></a>    <span class="dt">real_type</span> I0<span class="op">;</span></span>
<span id="cb16-20"><a href="#cb16-20" tabindex="-1"></a>    <span class="dt">real_type</span> beta<span class="op">;</span></span>
<span id="cb16-21"><a href="#cb16-21" tabindex="-1"></a>    <span class="dt">real_type</span> gamma<span class="op">;</span></span>
<span id="cb16-22"><a href="#cb16-22" tabindex="-1"></a>    <span class="dt">real_type</span> exp_noise<span class="op">;</span></span>
<span id="cb16-23"><a href="#cb16-23" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb16-24"><a href="#cb16-24" tabindex="-1"></a></span>
<span id="cb16-25"><a href="#cb16-25" tabindex="-1"></a>  <span class="kw">struct</span> internal_state <span class="op">{};</span></span>
<span id="cb16-26"><a href="#cb16-26" tabindex="-1"></a></span>
<span id="cb16-27"><a href="#cb16-27" tabindex="-1"></a>  <span class="kw">struct</span> <span class="dt">data_type</span> <span class="op">{</span></span>
<span id="cb16-28"><a href="#cb16-28" tabindex="-1"></a>    <span class="dt">real_type</span> incidence<span class="op">;</span></span>
<span id="cb16-29"><a href="#cb16-29" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb16-30"><a href="#cb16-30" tabindex="-1"></a></span>
<span id="cb16-31"><a href="#cb16-31" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">rng_state_type</span> <span class="op">=</span> monty<span class="op">::</span>random<span class="op">::</span>generator<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;;</span></span>
<span id="cb16-32"><a href="#cb16-32" tabindex="-1"></a></span>
<span id="cb16-33"><a href="#cb16-33" tabindex="-1"></a>  <span class="at">static</span> dust2<span class="op">::</span>packing packing_state<span class="op">(</span><span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-34"><a href="#cb16-34" tabindex="-1"></a>    <span class="cf">return</span> dust2<span class="op">::</span>packing<span class="op">{{</span><span class="st">"S"</span><span class="op">,</span> <span class="op">{}},</span> <span class="op">{</span><span class="st">"I"</span><span class="op">,</span> <span class="op">{}},</span> <span class="op">{</span><span class="st">"R"</span><span class="op">,</span> <span class="op">{}},</span> <span class="op">{</span><span class="st">"cases_inc"</span><span class="op">,</span> <span class="op">{}}};</span></span>
<span id="cb16-35"><a href="#cb16-35" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb16-36"><a href="#cb16-36" tabindex="-1"></a></span>
<span id="cb16-37"><a href="#cb16-37" tabindex="-1"></a>  <span class="at">static</span> shared_state build_shared<span class="op">(</span>cpp11<span class="op">::</span>list pars<span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-38"><a href="#cb16-38" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">real_type</span> I0 <span class="op">=</span> dust2<span class="op">::</span>r<span class="op">::</span>read_real<span class="op">(</span>pars<span class="op">,</span> <span class="st">"I0"</span><span class="op">,</span> <span class="dv">10</span><span class="op">);</span></span>
<span id="cb16-39"><a href="#cb16-39" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">real_type</span> N <span class="op">=</span> dust2<span class="op">::</span>r<span class="op">::</span>read_real<span class="op">(</span>pars<span class="op">,</span> <span class="st">"N"</span><span class="op">,</span> <span class="dv">1000</span><span class="op">);</span></span>
<span id="cb16-40"><a href="#cb16-40" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">real_type</span> beta <span class="op">=</span> dust2<span class="op">::</span>r<span class="op">::</span>read_real<span class="op">(</span>pars<span class="op">,</span> <span class="st">"beta"</span><span class="op">,</span> <span class="fl">0.2</span><span class="op">);</span></span>
<span id="cb16-41"><a href="#cb16-41" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">real_type</span> gamma <span class="op">=</span> dust2<span class="op">::</span>r<span class="op">::</span>read_real<span class="op">(</span>pars<span class="op">,</span> <span class="st">"gamma"</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">);</span></span>
<span id="cb16-42"><a href="#cb16-42" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">real_type</span> exp_noise <span class="op">=</span> dust2<span class="op">::</span>r<span class="op">::</span>read_real<span class="op">(</span>pars<span class="op">,</span> <span class="st">"exp_noise"</span><span class="op">,</span> <span class="fl">1e6</span><span class="op">);</span></span>
<span id="cb16-43"><a href="#cb16-43" tabindex="-1"></a>    <span class="cf">return</span> shared_state<span class="op">{</span>N<span class="op">,</span> I0<span class="op">,</span> beta<span class="op">,</span> gamma<span class="op">,</span> exp_noise<span class="op">};</span></span>
<span id="cb16-44"><a href="#cb16-44" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb16-45"><a href="#cb16-45" tabindex="-1"></a></span>
<span id="cb16-46"><a href="#cb16-46" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">void</span> update_shared<span class="op">(</span>cpp11<span class="op">::</span>list pars<span class="op">,</span> shared_state<span class="op">&amp;</span> shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-47"><a href="#cb16-47" tabindex="-1"></a>    shared<span class="op">.</span>I0 <span class="op">=</span> dust2<span class="op">::</span>r<span class="op">::</span>read_real<span class="op">(</span>pars<span class="op">,</span> <span class="st">"I0"</span><span class="op">,</span> shared<span class="op">.</span>I0<span class="op">);</span></span>
<span id="cb16-48"><a href="#cb16-48" tabindex="-1"></a>    shared<span class="op">.</span>beta <span class="op">=</span> dust2<span class="op">::</span>r<span class="op">::</span>read_real<span class="op">(</span>pars<span class="op">,</span> <span class="st">"beta"</span><span class="op">,</span> shared<span class="op">.</span>beta<span class="op">);</span></span>
<span id="cb16-49"><a href="#cb16-49" tabindex="-1"></a>    shared<span class="op">.</span>gamma <span class="op">=</span> dust2<span class="op">::</span>r<span class="op">::</span>read_real<span class="op">(</span>pars<span class="op">,</span> <span class="st">"gamma"</span><span class="op">,</span> shared<span class="op">.</span>gamma<span class="op">);</span></span>
<span id="cb16-50"><a href="#cb16-50" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb16-51"><a href="#cb16-51" tabindex="-1"></a></span>
<span id="cb16-52"><a href="#cb16-52" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">data_type</span> build_data<span class="op">(</span>cpp11<span class="op">::</span>list r_data<span class="op">,</span> <span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-53"><a href="#cb16-53" tabindex="-1"></a>    <span class="kw">auto</span> data <span class="op">=</span> <span class="kw">static_cast</span><span class="op">&lt;</span>cpp11<span class="op">::</span>list<span class="op">&gt;(</span>r_data<span class="op">);</span></span>
<span id="cb16-54"><a href="#cb16-54" tabindex="-1"></a>    <span class="kw">auto</span> incidence <span class="op">=</span> dust2<span class="op">::</span>r<span class="op">::</span>read_real<span class="op">(</span>data<span class="op">,</span> <span class="st">"incidence"</span><span class="op">,</span> NA_REAL<span class="op">);</span></span>
<span id="cb16-55"><a href="#cb16-55" tabindex="-1"></a>    <span class="cf">return</span> <span class="dt">data_type</span><span class="op">{</span>incidence<span class="op">};</span></span>
<span id="cb16-56"><a href="#cb16-56" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb16-57"><a href="#cb16-57" tabindex="-1"></a></span>
<span id="cb16-58"><a href="#cb16-58" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">void</span> initial<span class="op">(</span><span class="dt">real_type</span> time<span class="op">,</span></span>
<span id="cb16-59"><a href="#cb16-59" tabindex="-1"></a>                      <span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">,</span></span>
<span id="cb16-60"><a href="#cb16-60" tabindex="-1"></a>                      internal_state<span class="op">&amp;</span> internal<span class="op">,</span></span>
<span id="cb16-61"><a href="#cb16-61" tabindex="-1"></a>                      <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">,</span></span>
<span id="cb16-62"><a href="#cb16-62" tabindex="-1"></a>                      <span class="dt">real_type</span> <span class="op">*</span> state_next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-63"><a href="#cb16-63" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> shared<span class="op">.</span>N <span class="op">-</span> shared<span class="op">.</span>I0<span class="op">;</span></span>
<span id="cb16-64"><a href="#cb16-64" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> shared<span class="op">.</span>I0<span class="op">;</span></span>
<span id="cb16-65"><a href="#cb16-65" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb16-66"><a href="#cb16-66" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">3</span><span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb16-67"><a href="#cb16-67" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb16-68"><a href="#cb16-68" tabindex="-1"></a></span>
<span id="cb16-69"><a href="#cb16-69" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">void</span> update<span class="op">(</span><span class="dt">real_type</span> time<span class="op">,</span></span>
<span id="cb16-70"><a href="#cb16-70" tabindex="-1"></a>                     <span class="dt">real_type</span> dt<span class="op">,</span></span>
<span id="cb16-71"><a href="#cb16-71" tabindex="-1"></a>                     <span class="at">const</span> <span class="dt">real_type</span> <span class="op">*</span> state<span class="op">,</span></span>
<span id="cb16-72"><a href="#cb16-72" tabindex="-1"></a>                     <span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">,</span></span>
<span id="cb16-73"><a href="#cb16-73" tabindex="-1"></a>                     internal_state<span class="op">&amp;</span> internal<span class="op">,</span></span>
<span id="cb16-74"><a href="#cb16-74" tabindex="-1"></a>                     <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">,</span></span>
<span id="cb16-75"><a href="#cb16-75" tabindex="-1"></a>                     <span class="dt">real_type</span> <span class="op">*</span> state_next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-76"><a href="#cb16-76" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> S <span class="op">=</span> state<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb16-77"><a href="#cb16-77" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> I <span class="op">=</span> state<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb16-78"><a href="#cb16-78" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> R <span class="op">=</span> state<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb16-79"><a href="#cb16-79" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> cases_inc <span class="op">=</span> state<span class="op">[</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb16-80"><a href="#cb16-80" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> p_SI <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> monty<span class="op">::</span>math<span class="op">::</span>exp<span class="op">(-</span>shared<span class="op">.</span>beta <span class="op">*</span> I <span class="op">/</span> shared<span class="op">.</span>N <span class="op">*</span> dt<span class="op">);</span></span>
<span id="cb16-81"><a href="#cb16-81" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> p_IR <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> monty<span class="op">::</span>math<span class="op">::</span>exp<span class="op">(-</span>shared<span class="op">.</span>gamma <span class="op">*</span> dt<span class="op">);</span></span>
<span id="cb16-82"><a href="#cb16-82" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> n_SI <span class="op">=</span> monty<span class="op">::</span>random<span class="op">::</span>binomial<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>rng_state<span class="op">,</span> S<span class="op">,</span> p_SI<span class="op">);</span></span>
<span id="cb16-83"><a href="#cb16-83" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> n_IR <span class="op">=</span> monty<span class="op">::</span>random<span class="op">::</span>binomial<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>rng_state<span class="op">,</span> I<span class="op">,</span> p_IR<span class="op">);</span></span>
<span id="cb16-84"><a href="#cb16-84" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> S <span class="op">-</span> n_SI<span class="op">;</span></span>
<span id="cb16-85"><a href="#cb16-85" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> I <span class="op">+</span> n_SI <span class="op">-</span> n_IR<span class="op">;</span></span>
<span id="cb16-86"><a href="#cb16-86" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> R <span class="op">+</span> n_IR<span class="op">;</span></span>
<span id="cb16-87"><a href="#cb16-87" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">3</span><span class="op">]</span> <span class="op">=</span> cases_inc <span class="op">+</span> n_SI<span class="op">;</span></span>
<span id="cb16-88"><a href="#cb16-88" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb16-89"><a href="#cb16-89" tabindex="-1"></a></span>
<span id="cb16-90"><a href="#cb16-90" tabindex="-1"></a>  <span class="at">static</span> <span class="kw">auto</span> zero_every<span class="op">(</span><span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-91"><a href="#cb16-91" tabindex="-1"></a>    <span class="cf">return</span> dust2<span class="op">::</span><span class="dt">zero_every_type</span><span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;{{</span><span class="dv">1</span><span class="op">,</span> <span class="op">{</span><span class="dv">3</span><span class="op">}}};</span></span>
<span id="cb16-92"><a href="#cb16-92" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb16-93"><a href="#cb16-93" tabindex="-1"></a></span>
<span id="cb16-94"><a href="#cb16-94" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">real_type</span> compare_data<span class="op">(</span><span class="at">const</span> <span class="dt">real_type</span> time<span class="op">,</span></span>
<span id="cb16-95"><a href="#cb16-95" tabindex="-1"></a>                                <span class="at">const</span> <span class="dt">real_type</span> <span class="op">*</span> state<span class="op">,</span></span>
<span id="cb16-96"><a href="#cb16-96" tabindex="-1"></a>                                <span class="at">const</span> <span class="dt">data_type</span><span class="op">&amp;</span> data<span class="op">,</span></span>
<span id="cb16-97"><a href="#cb16-97" tabindex="-1"></a>                                <span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">,</span></span>
<span id="cb16-98"><a href="#cb16-98" tabindex="-1"></a>                                internal_state<span class="op">&amp;</span> internal<span class="op">,</span></span>
<span id="cb16-99"><a href="#cb16-99" tabindex="-1"></a>                                <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-100"><a href="#cb16-100" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> incidence_observed <span class="op">=</span> data<span class="op">.</span>incidence<span class="op">;</span></span>
<span id="cb16-101"><a href="#cb16-101" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span><span class="bu">std::</span>isnan<span class="op">(</span>data<span class="op">.</span>incidence<span class="op">))</span> <span class="op">{</span></span>
<span id="cb16-102"><a href="#cb16-102" tabindex="-1"></a>      <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb16-103"><a href="#cb16-103" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-104"><a href="#cb16-104" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> noise <span class="op">=</span></span>
<span id="cb16-105"><a href="#cb16-105" tabindex="-1"></a>      monty<span class="op">::</span>random<span class="op">::</span>exponential_rate<span class="op">(</span>rng_state<span class="op">,</span> shared<span class="op">.</span>exp_noise<span class="op">);</span></span>
<span id="cb16-106"><a href="#cb16-106" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> incidence_modelled <span class="op">=</span> state<span class="op">[</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb16-107"><a href="#cb16-107" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> lambda <span class="op">=</span> incidence_modelled <span class="op">+</span> noise<span class="op">;</span></span>
<span id="cb16-108"><a href="#cb16-108" tabindex="-1"></a>    <span class="cf">return</span> monty<span class="op">::</span>density<span class="op">::</span>poisson<span class="op">(</span>incidence_observed<span class="op">,</span> lambda<span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb16-109"><a href="#cb16-109" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb16-110"><a href="#cb16-110" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>This shows basically the same pattern as the random walk model above,
and here we highlight the additions and differences.</p>
<p>Our <code>packing_state</code> method looks more interesting and
potentially more useful now:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>  <span class="at">static</span> dust2<span class="op">::</span>packing packing_state<span class="op">(</span><span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>    <span class="cf">return</span> dust2<span class="op">::</span>packing<span class="op">{{</span><span class="st">"S"</span><span class="op">,</span> <span class="op">{}},</span> <span class="op">{</span><span class="st">"I"</span><span class="op">,</span> <span class="op">{}},</span> <span class="op">{</span><span class="st">"R"</span><span class="op">,</span> <span class="op">{}},</span> <span class="op">{</span><span class="st">"cases_inc"</span><span class="op">,</span> <span class="op">{}}};</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>Here, we have four variables; the <code>S</code>, <code>I</code> and
<code>R</code> compartments and <code>cases_inc</code> which holds the
<em>daily incidence</em> (the number of new cases per day). As with the
random walk model, these are still scalars (the second element of each
pair is still <code><a href="https://rdrr.io/r/base/Paren.html" class="external-link">{}</a></code>) but there are four elements now and the
order is determined by the order presented here.</p>
<p>The <code>build_shared</code> and <code>update_shared</code> have not
really changed in nature, but note that we’ve chosen only to support
updating three of the parameters within <code>update_shared</code>
(<code>I0</code>, <code>gamma</code> and <code>beta</code>). The
parameters <code>N</code> and <code>exp_noise</code> can only be set at
initialisation.</p>
<p>We’ve added a new type <code>data_type</code> and a
<code>build_data</code> method which creates it. The
<code>data_type</code> <code>struct</code> can hold arbitrary data, and
is used to represent an observation of one or more data streams at a
single point in time. When running within a particle filter (see
<code><a href="../reference/dust_filter_create.html">dust_filter_create()</a></code>) we will have <code>data.frame</code>
representing a time series of these observations.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>  <span class="kw">struct</span> <span class="dt">data_type</span> <span class="op">{</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>    <span class="dt">real_type</span> incidence<span class="op">;</span></span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>  <span class="op">};</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">data_type</span> build_data<span class="op">(</span>cpp11<span class="op">::</span>list r_data<span class="op">,</span> <span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>    <span class="kw">auto</span> data <span class="op">=</span> <span class="kw">static_cast</span><span class="op">&lt;</span>cpp11<span class="op">::</span>list<span class="op">&gt;(</span>r_data<span class="op">);</span></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>    <span class="kw">auto</span> incidence <span class="op">=</span> dust2<span class="op">::</span>r<span class="op">::</span>read_real<span class="op">(</span>data<span class="op">,</span> <span class="st">"incidence"</span><span class="op">,</span> NA_REAL<span class="op">);</span></span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>    <span class="cf">return</span> <span class="dt">data_type</span><span class="op">{</span>incidence<span class="op">};</span></span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>Our initial condition function now actually sets an initial
condition!</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">void</span> initial<span class="op">(</span><span class="dt">real_type</span> time<span class="op">,</span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a>                      <span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">,</span></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a>                      internal_state<span class="op">&amp;</span> internal<span class="op">,</span></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a>                      <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">,</span></span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a>                      <span class="dt">real_type</span> <span class="op">*</span> state_next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> shared<span class="op">.</span>N <span class="op">-</span> shared<span class="op">.</span>I0<span class="op">;</span></span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> shared<span class="op">.</span>I0<span class="op">;</span></span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">3</span><span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>The first element (<code>S</code>; see <code>packing_state</code>) is
set to <code>N - I0</code> and the second element (<code>I</code>) is
set to <code>I0</code> with the remaining two states zeroed.</p>
<p>The <code>update</code> method is similar in nature to the random
walk model, just a bit longer:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">void</span> update<span class="op">(</span><span class="dt">real_type</span> time<span class="op">,</span></span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a>                     <span class="dt">real_type</span> dt<span class="op">,</span></span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a>                     <span class="at">const</span> <span class="dt">real_type</span> <span class="op">*</span> state<span class="op">,</span></span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a>                     <span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">,</span></span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a>                     internal_state<span class="op">&amp;</span> internal<span class="op">,</span></span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a>                     <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">,</span></span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a>                     <span class="dt">real_type</span> <span class="op">*</span> state_next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> S <span class="op">=</span> state<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb21-9"><a href="#cb21-9" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> I <span class="op">=</span> state<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb21-10"><a href="#cb21-10" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> R <span class="op">=</span> state<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb21-11"><a href="#cb21-11" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> cases_inc <span class="op">=</span> state<span class="op">[</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb21-12"><a href="#cb21-12" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> p_SI <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> monty<span class="op">::</span>math<span class="op">::</span>exp<span class="op">(-</span>shared<span class="op">.</span>beta <span class="op">*</span> I <span class="op">/</span> shared<span class="op">.</span>N <span class="op">*</span> dt<span class="op">);</span></span>
<span id="cb21-13"><a href="#cb21-13" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> p_IR <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> monty<span class="op">::</span>math<span class="op">::</span>exp<span class="op">(-</span>shared<span class="op">.</span>gamma <span class="op">*</span> dt<span class="op">);</span></span>
<span id="cb21-14"><a href="#cb21-14" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> n_SI <span class="op">=</span> monty<span class="op">::</span>random<span class="op">::</span>binomial<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>rng_state<span class="op">,</span> S<span class="op">,</span> p_SI<span class="op">);</span></span>
<span id="cb21-15"><a href="#cb21-15" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> n_IR <span class="op">=</span> monty<span class="op">::</span>random<span class="op">::</span>binomial<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>rng_state<span class="op">,</span> I<span class="op">,</span> p_IR<span class="op">);</span></span>
<span id="cb21-16"><a href="#cb21-16" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> S <span class="op">-</span> n_SI<span class="op">;</span></span>
<span id="cb21-17"><a href="#cb21-17" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> I <span class="op">+</span> n_SI <span class="op">-</span> n_IR<span class="op">;</span></span>
<span id="cb21-18"><a href="#cb21-18" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> R <span class="op">+</span> n_IR<span class="op">;</span></span>
<span id="cb21-19"><a href="#cb21-19" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">3</span><span class="op">]</span> <span class="op">=</span> cases_inc <span class="op">+</span> n_SI<span class="op">;</span></span>
<span id="cb21-20"><a href="#cb21-20" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>The update for <code>cases_inc</code> deserves some extra
attention:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">3</span><span class="op">]</span> <span class="op">=</span> cases_inc <span class="op">+</span> n_SI<span class="op">;</span></span></code></pre></div>
<p>You might think that this will simply compute <strong>cumulative
cases</strong>, and you would be right if it were not for the
<code>zero_every</code> method:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a>  <span class="at">static</span> <span class="kw">auto</span> zero_every<span class="op">(</span><span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>    <span class="cf">return</span> dust2<span class="op">::</span><span class="dt">zero_every_type</span><span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;{{</span><span class="dv">1</span><span class="op">,</span> <span class="op">{</span><span class="dv">3</span><span class="op">}}};</span></span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>This declares that every <code>1</code> time unit (the first element
of the inner <code><a href="https://rdrr.io/r/base/Paren.html" class="external-link">{}</a></code>) we will zero the data at element(s)
<code>{3}</code>. This latter argument might be a vector, so saying
<code>{7, {3, 4, 5}}</code> would read as “every 7 time units, zero
elements 3 to 5”. The outer <code><a href="https://rdrr.io/r/base/Paren.html" class="external-link">{}</a></code> allows us to have multiple
different zeroed variables, so we could write
<code>dust2::zero_every_type&lt;real_type&gt;{{1, {3}, {7, {4}}}</code>
if we added another variable for weekly incidence.</p>
<p>Finally, we have <code>compare_data</code>:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">real_type</span> compare_data<span class="op">(</span><span class="at">const</span> <span class="dt">real_type</span> time<span class="op">,</span></span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>                                <span class="at">const</span> <span class="dt">real_type</span> <span class="op">*</span> state<span class="op">,</span></span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a>                                <span class="at">const</span> <span class="dt">data_type</span><span class="op">&amp;</span> data<span class="op">,</span></span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a>                                <span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">,</span></span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a>                                internal_state<span class="op">&amp;</span> internal<span class="op">,</span></span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a>                                <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">)</span> <span class="op">{</span></span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> incidence_observed <span class="op">=</span> data<span class="op">.</span>incidence<span class="op">;</span></span>
<span id="cb24-8"><a href="#cb24-8" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span><span class="bu">std::</span>isnan<span class="op">(</span>data<span class="op">.</span>incidence<span class="op">))</span> <span class="op">{</span></span>
<span id="cb24-9"><a href="#cb24-9" tabindex="-1"></a>      <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-10"><a href="#cb24-10" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-11"><a href="#cb24-11" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> noise <span class="op">=</span></span>
<span id="cb24-12"><a href="#cb24-12" tabindex="-1"></a>      monty<span class="op">::</span>random<span class="op">::</span>exponential_rate<span class="op">(</span>rng_state<span class="op">,</span> shared<span class="op">.</span>exp_noise<span class="op">);</span></span>
<span id="cb24-13"><a href="#cb24-13" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> incidence_modelled <span class="op">=</span> state<span class="op">[</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb24-14"><a href="#cb24-14" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> lambda <span class="op">=</span> incidence_modelled <span class="op">+</span> noise<span class="op">;</span></span>
<span id="cb24-15"><a href="#cb24-15" tabindex="-1"></a>    <span class="cf">return</span> monty<span class="op">::</span>density<span class="op">::</span>poisson<span class="op">(</span>incidence_observed<span class="op">,</span> lambda<span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb24-16"><a href="#cb24-16" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>This has the same long sort of call signature as <code>initial</code>
and <code>update</code> but with <strong>read-only</strong>
<code>state</code> and <strong>read-only</strong> data. Here, we return
a single real number, being the log-likelihood at this point. In this
example we add some small random noise to the modelled data (to avoid
<code>NaN</code>s where our modelled cases are zero) and compute the log
density from a Poisson distribution for observing the cases in
<code>data</code>.</p>
</div>
<div class="section level2">
<h2 id="continuous-time-ode-models">Continuous time (ODE) models<a class="anchor" aria-label="anchor" href="#continuous-time-ode-models"></a>
</h2>
<p>The interface looks slightly different for ODE models, because we are
not updating the system from one time to the next but computing the
<em>rate of change</em> at a given time and an <a href="https://en.wikipedia.org/wiki/Numerical_methods_for_ordinary_differential_equations" class="external-link">ODE
solver</a> is updating the values of the system. So rather than an
<code><a href="https://rdrr.io/r/stats/update.html" class="external-link">update()</a></code> method, we will write an <code>rhs()</code>
method. The implementation here follows as that of the sir model above,
and very little has changed:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;dust2/common.hpp&gt;</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a><span class="co">// [[dust2::class(sirode)]]</span></span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a><span class="co">// [[dust2::time_type(continuous)]]</span></span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a><span class="co">// [[dust2::has_compare()]]</span></span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a><span class="co">// [[dust2::parameter(I0, constant = FALSE)]]</span></span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a><span class="co">// [[dust2::parameter(N, constant = TRUE)]]</span></span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a><span class="co">// [[dust2::parameter(beta, constant = FALSE)]]</span></span>
<span id="cb25-9"><a href="#cb25-9" tabindex="-1"></a><span class="co">// [[dust2::parameter(gamma, constant = FALSE)]]</span></span>
<span id="cb25-10"><a href="#cb25-10" tabindex="-1"></a><span class="kw">class</span> sirode <span class="op">{</span></span>
<span id="cb25-11"><a href="#cb25-11" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb25-12"><a href="#cb25-12" tabindex="-1"></a>  sirode<span class="op">()</span> <span class="op">=</span> <span class="kw">delete</span><span class="op">;</span></span>
<span id="cb25-13"><a href="#cb25-13" tabindex="-1"></a></span>
<span id="cb25-14"><a href="#cb25-14" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">real_type</span> <span class="op">=</span> <span class="dt">double</span><span class="op">;</span></span>
<span id="cb25-15"><a href="#cb25-15" tabindex="-1"></a></span>
<span id="cb25-16"><a href="#cb25-16" tabindex="-1"></a>  <span class="kw">struct</span> shared_state <span class="op">{</span></span>
<span id="cb25-17"><a href="#cb25-17" tabindex="-1"></a>    <span class="dt">real_type</span> N<span class="op">;</span></span>
<span id="cb25-18"><a href="#cb25-18" tabindex="-1"></a>    <span class="dt">real_type</span> I0<span class="op">;</span></span>
<span id="cb25-19"><a href="#cb25-19" tabindex="-1"></a>    <span class="dt">real_type</span> beta<span class="op">;</span></span>
<span id="cb25-20"><a href="#cb25-20" tabindex="-1"></a>    <span class="dt">real_type</span> gamma<span class="op">;</span></span>
<span id="cb25-21"><a href="#cb25-21" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb25-22"><a href="#cb25-22" tabindex="-1"></a></span>
<span id="cb25-23"><a href="#cb25-23" tabindex="-1"></a>  <span class="kw">struct</span> internal_state <span class="op">{};</span></span>
<span id="cb25-24"><a href="#cb25-24" tabindex="-1"></a></span>
<span id="cb25-25"><a href="#cb25-25" tabindex="-1"></a>  <span class="kw">struct</span> <span class="dt">data_type</span> <span class="op">{</span></span>
<span id="cb25-26"><a href="#cb25-26" tabindex="-1"></a>    <span class="dt">real_type</span> incidence<span class="op">;</span></span>
<span id="cb25-27"><a href="#cb25-27" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb25-28"><a href="#cb25-28" tabindex="-1"></a></span>
<span id="cb25-29"><a href="#cb25-29" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">rng_state_type</span> <span class="op">=</span> monty<span class="op">::</span>random<span class="op">::</span>generator<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;;</span></span>
<span id="cb25-30"><a href="#cb25-30" tabindex="-1"></a></span>
<span id="cb25-31"><a href="#cb25-31" tabindex="-1"></a>  <span class="at">static</span> dust2<span class="op">::</span>packing packing_state<span class="op">(</span><span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-32"><a href="#cb25-32" tabindex="-1"></a>    <span class="cf">return</span> dust2<span class="op">::</span>packing<span class="op">{{</span><span class="st">"S"</span><span class="op">,</span> <span class="op">{}},</span> <span class="op">{</span><span class="st">"I"</span><span class="op">,</span> <span class="op">{}},</span> <span class="op">{</span><span class="st">"R"</span><span class="op">,</span> <span class="op">{}},</span> <span class="op">{</span><span class="st">"cases_inc"</span><span class="op">,</span> <span class="op">{}}};</span></span>
<span id="cb25-33"><a href="#cb25-33" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb25-34"><a href="#cb25-34" tabindex="-1"></a></span>
<span id="cb25-35"><a href="#cb25-35" tabindex="-1"></a>  <span class="at">static</span> shared_state build_shared<span class="op">(</span>cpp11<span class="op">::</span>list pars<span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-36"><a href="#cb25-36" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">real_type</span> I0 <span class="op">=</span> dust2<span class="op">::</span>r<span class="op">::</span>read_real<span class="op">(</span>pars<span class="op">,</span> <span class="st">"I0"</span><span class="op">,</span> <span class="dv">10</span><span class="op">);</span></span>
<span id="cb25-37"><a href="#cb25-37" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">real_type</span> N <span class="op">=</span> dust2<span class="op">::</span>r<span class="op">::</span>read_real<span class="op">(</span>pars<span class="op">,</span> <span class="st">"N"</span><span class="op">,</span> <span class="dv">1000</span><span class="op">);</span></span>
<span id="cb25-38"><a href="#cb25-38" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">real_type</span> beta <span class="op">=</span> dust2<span class="op">::</span>r<span class="op">::</span>read_real<span class="op">(</span>pars<span class="op">,</span> <span class="st">"beta"</span><span class="op">,</span> <span class="fl">0.2</span><span class="op">);</span></span>
<span id="cb25-39"><a href="#cb25-39" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">real_type</span> gamma <span class="op">=</span> dust2<span class="op">::</span>r<span class="op">::</span>read_real<span class="op">(</span>pars<span class="op">,</span> <span class="st">"gamma"</span><span class="op">,</span> <span class="fl">0.1</span><span class="op">);</span></span>
<span id="cb25-40"><a href="#cb25-40" tabindex="-1"></a>    <span class="cf">return</span> shared_state<span class="op">{</span>N<span class="op">,</span> I0<span class="op">,</span> beta<span class="op">,</span> gamma<span class="op">};</span></span>
<span id="cb25-41"><a href="#cb25-41" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb25-42"><a href="#cb25-42" tabindex="-1"></a></span>
<span id="cb25-43"><a href="#cb25-43" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">void</span> update_shared<span class="op">(</span>cpp11<span class="op">::</span>list pars<span class="op">,</span> shared_state<span class="op">&amp;</span> shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-44"><a href="#cb25-44" tabindex="-1"></a>    shared<span class="op">.</span>I0 <span class="op">=</span> dust2<span class="op">::</span>r<span class="op">::</span>read_real<span class="op">(</span>pars<span class="op">,</span> <span class="st">"I0"</span><span class="op">,</span> shared<span class="op">.</span>I0<span class="op">);</span></span>
<span id="cb25-45"><a href="#cb25-45" tabindex="-1"></a>    shared<span class="op">.</span>beta <span class="op">=</span> dust2<span class="op">::</span>r<span class="op">::</span>read_real<span class="op">(</span>pars<span class="op">,</span> <span class="st">"beta"</span><span class="op">,</span> shared<span class="op">.</span>beta<span class="op">);</span></span>
<span id="cb25-46"><a href="#cb25-46" tabindex="-1"></a>    shared<span class="op">.</span>gamma <span class="op">=</span> dust2<span class="op">::</span>r<span class="op">::</span>read_real<span class="op">(</span>pars<span class="op">,</span> <span class="st">"gamma"</span><span class="op">,</span> shared<span class="op">.</span>gamma<span class="op">);</span></span>
<span id="cb25-47"><a href="#cb25-47" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb25-48"><a href="#cb25-48" tabindex="-1"></a></span>
<span id="cb25-49"><a href="#cb25-49" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">data_type</span> build_data<span class="op">(</span>cpp11<span class="op">::</span>list r_data<span class="op">,</span> <span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-50"><a href="#cb25-50" tabindex="-1"></a>    <span class="kw">auto</span> data <span class="op">=</span> <span class="kw">static_cast</span><span class="op">&lt;</span>cpp11<span class="op">::</span>list<span class="op">&gt;(</span>r_data<span class="op">);</span></span>
<span id="cb25-51"><a href="#cb25-51" tabindex="-1"></a>    <span class="kw">auto</span> incidence <span class="op">=</span> dust2<span class="op">::</span>r<span class="op">::</span>read_real<span class="op">(</span>data<span class="op">,</span> <span class="st">"incidence"</span><span class="op">,</span> NA_REAL<span class="op">);</span></span>
<span id="cb25-52"><a href="#cb25-52" tabindex="-1"></a>    <span class="cf">return</span> <span class="dt">data_type</span><span class="op">{</span>incidence<span class="op">};</span></span>
<span id="cb25-53"><a href="#cb25-53" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb25-54"><a href="#cb25-54" tabindex="-1"></a></span>
<span id="cb25-55"><a href="#cb25-55" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">void</span> initial<span class="op">(</span><span class="dt">real_type</span> time<span class="op">,</span></span>
<span id="cb25-56"><a href="#cb25-56" tabindex="-1"></a>                      <span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">,</span></span>
<span id="cb25-57"><a href="#cb25-57" tabindex="-1"></a>                      internal_state<span class="op">&amp;</span> internal<span class="op">,</span></span>
<span id="cb25-58"><a href="#cb25-58" tabindex="-1"></a>                      <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">,</span></span>
<span id="cb25-59"><a href="#cb25-59" tabindex="-1"></a>                      <span class="dt">real_type</span> <span class="op">*</span> state_next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-60"><a href="#cb25-60" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> shared<span class="op">.</span>N <span class="op">-</span> shared<span class="op">.</span>I0<span class="op">;</span></span>
<span id="cb25-61"><a href="#cb25-61" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> shared<span class="op">.</span>I0<span class="op">;</span></span>
<span id="cb25-62"><a href="#cb25-62" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb25-63"><a href="#cb25-63" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">3</span><span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb25-64"><a href="#cb25-64" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb25-65"><a href="#cb25-65" tabindex="-1"></a></span>
<span id="cb25-66"><a href="#cb25-66" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">void</span> rhs<span class="op">(</span><span class="dt">real_type</span> time<span class="op">,</span></span>
<span id="cb25-67"><a href="#cb25-67" tabindex="-1"></a>                  <span class="at">const</span> <span class="dt">real_type</span> <span class="op">*</span> state<span class="op">,</span></span>
<span id="cb25-68"><a href="#cb25-68" tabindex="-1"></a>                  <span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">,</span></span>
<span id="cb25-69"><a href="#cb25-69" tabindex="-1"></a>                  internal_state<span class="op">&amp;</span> internal<span class="op">,</span></span>
<span id="cb25-70"><a href="#cb25-70" tabindex="-1"></a>                  <span class="dt">real_type</span> <span class="op">*</span> state_deriv<span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-71"><a href="#cb25-71" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> S <span class="op">=</span> state<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb25-72"><a href="#cb25-72" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> I <span class="op">=</span> state<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb25-73"><a href="#cb25-73" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> rate_SI <span class="op">=</span> shared<span class="op">.</span>beta <span class="op">*</span> S <span class="op">*</span> I <span class="op">/</span> shared<span class="op">.</span>N<span class="op">;</span></span>
<span id="cb25-74"><a href="#cb25-74" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> rate_IR <span class="op">=</span> shared<span class="op">.</span>gamma <span class="op">*</span> I<span class="op">;</span></span>
<span id="cb25-75"><a href="#cb25-75" tabindex="-1"></a>    state_deriv<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="op">-</span>rate_SI<span class="op">;</span></span>
<span id="cb25-76"><a href="#cb25-76" tabindex="-1"></a>    state_deriv<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> rate_SI <span class="op">-</span> rate_IR<span class="op">;</span></span>
<span id="cb25-77"><a href="#cb25-77" tabindex="-1"></a>    state_deriv<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> rate_IR<span class="op">;</span></span>
<span id="cb25-78"><a href="#cb25-78" tabindex="-1"></a>    state_deriv<span class="op">[</span><span class="dv">3</span><span class="op">]</span> <span class="op">=</span> rate_SI<span class="op">;</span></span>
<span id="cb25-79"><a href="#cb25-79" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb25-80"><a href="#cb25-80" tabindex="-1"></a></span>
<span id="cb25-81"><a href="#cb25-81" tabindex="-1"></a>  <span class="at">static</span> <span class="kw">auto</span> zero_every<span class="op">(</span><span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-82"><a href="#cb25-82" tabindex="-1"></a>    <span class="cf">return</span> dust2<span class="op">::</span><span class="dt">zero_every_type</span><span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;{{</span><span class="dv">1</span><span class="op">,</span> <span class="op">{</span><span class="dv">3</span><span class="op">}}};</span></span>
<span id="cb25-83"><a href="#cb25-83" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb25-84"><a href="#cb25-84" tabindex="-1"></a></span>
<span id="cb25-85"><a href="#cb25-85" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">real_type</span> compare_data<span class="op">(</span><span class="at">const</span> <span class="dt">real_type</span> time<span class="op">,</span></span>
<span id="cb25-86"><a href="#cb25-86" tabindex="-1"></a>                                <span class="at">const</span> <span class="dt">real_type</span> <span class="op">*</span> state<span class="op">,</span></span>
<span id="cb25-87"><a href="#cb25-87" tabindex="-1"></a>                                <span class="at">const</span> <span class="dt">data_type</span><span class="op">&amp;</span> data<span class="op">,</span></span>
<span id="cb25-88"><a href="#cb25-88" tabindex="-1"></a>                                <span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">,</span></span>
<span id="cb25-89"><a href="#cb25-89" tabindex="-1"></a>                                internal_state<span class="op">&amp;</span> internal<span class="op">,</span></span>
<span id="cb25-90"><a href="#cb25-90" tabindex="-1"></a>                                <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-91"><a href="#cb25-91" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> incidence_observed <span class="op">=</span> data<span class="op">.</span>incidence<span class="op">;</span></span>
<span id="cb25-92"><a href="#cb25-92" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span><span class="bu">std::</span>isnan<span class="op">(</span>incidence_observed<span class="op">))</span> <span class="op">{</span></span>
<span id="cb25-93"><a href="#cb25-93" tabindex="-1"></a>      <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb25-94"><a href="#cb25-94" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-95"><a href="#cb25-95" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> lambda <span class="op">=</span> state<span class="op">[</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb25-96"><a href="#cb25-96" tabindex="-1"></a>    <span class="cf">return</span> monty<span class="op">::</span>density<span class="op">::</span>poisson<span class="op">(</span>incidence_observed<span class="op">,</span> lambda<span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb25-97"><a href="#cb25-97" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb25-98"><a href="#cb25-98" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>We have made changes to the annotations, replaced <code>update</code>
with <code>rhs</code> and updated <code>compare_data</code>, otherwise
everything remains the same (except for a minor change dropping the
<code>exp_noise</code> parameter which was not needed here).</p>
<p>The annotations have replaced</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="co">// [[dust2::time_type(discrete)]]</span></span></code></pre></div>
<p>with</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="co">// [[dust2::time_type(continous)]]</span></span></code></pre></div>
<p>The <code>rhs</code> method follows the <code>sir</code> model’s
update one closely, but returns rates into <code>state_deriv</code>
rather than updating <code>state_next</code>. Note that this function
does not accept an <code>rng_state</code> argument.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">void</span> rhs<span class="op">(</span><span class="dt">real_type</span> time<span class="op">,</span></span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>                  <span class="at">const</span> <span class="dt">real_type</span> <span class="op">*</span> state<span class="op">,</span></span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a>                  <span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">,</span></span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a>                  internal_state<span class="op">&amp;</span> internal<span class="op">,</span></span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a>                  <span class="dt">real_type</span> <span class="op">*</span> state_deriv<span class="op">)</span> <span class="op">{</span></span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> S <span class="op">=</span> state<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> I <span class="op">=</span> state<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb28-8"><a href="#cb28-8" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> rate_SI <span class="op">=</span> shared<span class="op">.</span>beta <span class="op">*</span> S <span class="op">*</span> I <span class="op">/</span> shared<span class="op">.</span>N<span class="op">;</span></span>
<span id="cb28-9"><a href="#cb28-9" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> rate_IR <span class="op">=</span> shared<span class="op">.</span>gamma <span class="op">*</span> I<span class="op">;</span></span>
<span id="cb28-10"><a href="#cb28-10" tabindex="-1"></a>    state_deriv<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="op">-</span>rate_SI<span class="op">;</span></span>
<span id="cb28-11"><a href="#cb28-11" tabindex="-1"></a>    state_deriv<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> rate_SI <span class="op">-</span> rate_IR<span class="op">;</span></span>
<span id="cb28-12"><a href="#cb28-12" tabindex="-1"></a>    state_deriv<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> rate_IR<span class="op">;</span></span>
<span id="cb28-13"><a href="#cb28-13" tabindex="-1"></a>    state_deriv<span class="op">[</span><span class="dv">3</span><span class="op">]</span> <span class="op">=</span> rate_SI<span class="op">;</span></span>
<span id="cb28-14"><a href="#cb28-14" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>The <code>compare_data</code> method has changed slightly as we no
longer add random noise to the modelled data:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">real_type</span> compare_data<span class="op">(</span><span class="at">const</span> <span class="dt">real_type</span> time<span class="op">,</span></span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a>                                <span class="at">const</span> <span class="dt">real_type</span> <span class="op">*</span> state<span class="op">,</span></span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a>                                <span class="at">const</span> <span class="dt">data_type</span><span class="op">&amp;</span> data<span class="op">,</span></span>
<span id="cb29-4"><a href="#cb29-4" tabindex="-1"></a>                                <span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">,</span></span>
<span id="cb29-5"><a href="#cb29-5" tabindex="-1"></a>                                internal_state<span class="op">&amp;</span> internal<span class="op">,</span></span>
<span id="cb29-6"><a href="#cb29-6" tabindex="-1"></a>                                <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">)</span> <span class="op">{</span></span>
<span id="cb29-7"><a href="#cb29-7" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> incidence_observed <span class="op">=</span> data<span class="op">.</span>incidence<span class="op">;</span></span>
<span id="cb29-8"><a href="#cb29-8" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span><span class="bu">std::</span>isnan<span class="op">(</span>incidence_observed<span class="op">))</span> <span class="op">{</span></span>
<span id="cb29-9"><a href="#cb29-9" tabindex="-1"></a>      <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb29-10"><a href="#cb29-10" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb29-11"><a href="#cb29-11" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> lambda <span class="op">=</span> state<span class="op">[</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb29-12"><a href="#cb29-12" tabindex="-1"></a>    <span class="cf">return</span> monty<span class="op">::</span>density<span class="op">::</span>poisson<span class="op">(</span>incidence_observed<span class="op">,</span> lambda<span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb29-13"><a href="#cb29-13" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="continuous-time-models-with-additional-output">Continuous time models with additional output<a class="anchor" aria-label="anchor" href="#continuous-time-models-with-additional-output"></a>
</h2>
<p>Sometimes it will be convenient to have models where you have
variables that are not updated as ODEs, but with some variables being a
compound expression of your variables. You can always do this in post
processing, but this can save pulling a lot of data back into R or allow
reusing values that you have computed in your <code>shared</code>
object.</p>
<p>To do this, list the variables as normal in
<code>packing_state</code> but make sure that they are the final
variables. Suppose that in the <code>sirode</code> model above, we
wanted to track <code>N</code>, the total population size (ignore that
this is a parameter and assume perhaps that we have an open system or
that we are aggregating over age groups). We could then write:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a>  <span class="at">static</span> dust2<span class="op">::</span>packing packing_state<span class="op">(</span><span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a>    <span class="cf">return</span> dust2<span class="op">::</span>packing<span class="op">{{</span><span class="st">"S"</span><span class="op">,</span> <span class="op">{}},</span> <span class="op">{</span><span class="st">"I"</span><span class="op">,</span> <span class="op">{}},</span> <span class="op">{</span><span class="st">"R"</span><span class="op">,</span> <span class="op">{}},</span> <span class="op">{</span><span class="st">"cases_inc"</span><span class="op">,</span> <span class="op">{}},</span> <span class="op">{</span><span class="st">"N"</span><span class="op">,</span> <span class="op">{}}};</span></span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>to add the additional “variable” into our state. We then write</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">size_t</span> size_output<span class="op">()</span> <span class="op">{</span></span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb31-3"><a href="#cb31-3" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>to indicate that the last 1 entry in <code>packing_state</code> is
not an ODE variable. Finally we could define</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">void</span> output<span class="op">(</span><span class="dt">real_type</span> time<span class="op">,</span></span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a>                     <span class="dt">real_type</span> <span class="op">*</span> state<span class="op">,</span></span>
<span id="cb32-3"><a href="#cb32-3" tabindex="-1"></a>                     <span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">,</span></span>
<span id="cb32-4"><a href="#cb32-4" tabindex="-1"></a>                     internal_state<span class="op">&amp;</span> internal<span class="op">)</span> <span class="op">{</span></span>
<span id="cb32-5"><a href="#cb32-5" tabindex="-1"></a>    state<span class="op">[</span><span class="dv">4</span><span class="op">]</span> <span class="op">=</span> state<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">+</span> state<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">+</span> state<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb32-6"><a href="#cb32-6" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>which would set the 5th element of <code>state</code> to the sum over
the first three (<code>N = S + I + R</code>). Note that this takes
<code>state</code> as a read-write variable and not a constant
variable.</p>
</div>
<div class="section level2">
<h2 id="continuous-time-models-with-special-variables">Continuous time models with special variables<a class="anchor" aria-label="anchor" href="#continuous-time-models-with-special-variables"></a>
</h2>
<p>There is a third class of variables that we need to consider, too;
variables that form part of model state, but which do not update as part
of the <code>rhs</code>; we will allow these to be referenced in the
calculations, but they should not be changed in the <code>rhs</code>.
These <strong>can</strong> be changed in:</p>
<ul>
<li>Any event</li>
<li>The <code>update</code> function, for mixed-time models</li>
<li>As part of the initial conditions (e.g., via
<code>dust_system_set_state</code>)</li>
</ul>
<p>The total state vector is composed of a series of logical components,
as specified by <code>packing_state()</code>. We have three
non-overlapping “blocks” of components, in order:</p>
<ul>
<li>ode variables - always present as input, <code>rhs</code> must
produce a derivative for these, and the value can be looked up anywhere.
You must provide an initial condition.</li>
<li>special variables - always present as input, but excluded from
calculation of derivatives. You must provide an initial condition, and
you must update within the <code><a href="https://rdrr.io/r/stats/update.html" class="external-link">update()</a></code> function (if used). You
may also change these within events.</li>
<li>output variables - present only in output, cannot be present in
initial conditions, cannot be looked up.</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Rich FitzJohn.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>

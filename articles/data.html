<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Comparing dust systems to data • dust2</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Comparing dust systems to data">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">dust2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.28</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/dust2.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/design.html">Principles and design of dust</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Details</h6></li>
    <li><a class="dropdown-item" href="../articles/data.html">Comparing dust systems to data</a></li>
    <li><a class="dropdown-item" href="../articles/details.html">Details</a></li>
    <li><a class="dropdown-item" href="../articles/packaging.html">Packaging dust systems</a></li>
    <li><a class="dropdown-item" href="../articles/periodic.html">Periodic variables details</a></li>
    <li><a class="dropdown-item" href="../articles/writing.html">Writing dust2 systems</a></li>
    <li><a class="dropdown-item" href="../articles/migrating.html">Migrating from dust 1.x.x</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mrc-ide/dust2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Comparing dust systems to data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/dust2/blob/main/vignettes/data.Rmd" class="external-link"><code>vignettes/data.Rmd</code></a></small>
      <div class="d-none name"><code>data.Rmd</code></div>
    </div>

    
    
<p>One of our aims with <code>dust</code> was to enable the creation of
fast particle filters. This vignette outlines the steps in implementing
the comparison directly as part of the model, and compares the result
against a known deterministic result.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mrc-ide/dust2" class="external-link">dust2</a></span><span class="op">)</span></span></code></pre></div>
<p>We start with a simple example, a model of volatility. For
completeness (and because the maths around this will need adding later!)
we show the full code here:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;dust2/common.hpp&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="co">// [[dust2::class(volatility)]]</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="co">// [[dust2::time_type(discrete)]]</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="co">// [[dust2::has_compare()]]</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a><span class="co">// [[dust2::parameter(alpha)]]</span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a><span class="co">// [[dust2::parameter(sigma)]]</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a><span class="co">// [[dust2::parameter(gamma)]]</span></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a><span class="co">// [[dust2::parameter(tau)]]</span></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a><span class="kw">class</span> volatility <span class="op">{</span></span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>  volatility<span class="op">()</span> <span class="op">=</span> <span class="kw">delete</span><span class="op">;</span></span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">real_type</span> <span class="op">=</span> <span class="dt">double</span><span class="op">;</span></span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a>  <span class="kw">struct</span> shared_state <span class="op">{</span></span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a>    <span class="dt">real_type</span> alpha<span class="op">;</span></span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a>    <span class="dt">real_type</span> sigma<span class="op">;</span></span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a>    <span class="dt">real_type</span> gamma<span class="op">;</span></span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a>    <span class="dt">real_type</span> tau<span class="op">;</span></span>
<span id="cb2-21"><a href="#cb2-21" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb2-22"><a href="#cb2-22" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" tabindex="-1"></a>  <span class="kw">struct</span> internal_state <span class="op">{};</span></span>
<span id="cb2-24"><a href="#cb2-24" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" tabindex="-1"></a>  <span class="kw">struct</span> <span class="dt">data_type</span> <span class="op">{</span></span>
<span id="cb2-26"><a href="#cb2-26" tabindex="-1"></a>    <span class="dt">real_type</span> observed<span class="op">;</span></span>
<span id="cb2-27"><a href="#cb2-27" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb2-28"><a href="#cb2-28" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">rng_state_type</span> <span class="op">=</span> monty<span class="op">::</span>random<span class="op">::</span>generator<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;;</span></span>
<span id="cb2-30"><a href="#cb2-30" tabindex="-1"></a></span>
<span id="cb2-31"><a href="#cb2-31" tabindex="-1"></a>  <span class="at">static</span> dust2<span class="op">::</span>packing packing_state<span class="op">(</span><span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-32"><a href="#cb2-32" tabindex="-1"></a>    <span class="cf">return</span> dust2<span class="op">::</span>packing<span class="op">{{</span><span class="st">"x"</span><span class="op">,</span> <span class="op">{}}};</span></span>
<span id="cb2-33"><a href="#cb2-33" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb2-34"><a href="#cb2-34" tabindex="-1"></a></span>
<span id="cb2-35"><a href="#cb2-35" tabindex="-1"></a>  <span class="at">static</span> shared_state build_shared<span class="op">(</span>cpp11<span class="op">::</span>list pars<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-36"><a href="#cb2-36" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> alpha <span class="op">=</span> dust2<span class="op">::</span>r<span class="op">::</span>read_real<span class="op">(</span>pars<span class="op">,</span> <span class="st">"alpha"</span><span class="op">,</span> <span class="fl">0.91</span><span class="op">);</span></span>
<span id="cb2-37"><a href="#cb2-37" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> sigma <span class="op">=</span> dust2<span class="op">::</span>r<span class="op">::</span>read_real<span class="op">(</span>pars<span class="op">,</span> <span class="st">"sigma"</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb2-38"><a href="#cb2-38" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> gamma <span class="op">=</span> dust2<span class="op">::</span>r<span class="op">::</span>read_real<span class="op">(</span>pars<span class="op">,</span> <span class="st">"gamma"</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb2-39"><a href="#cb2-39" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> tau <span class="op">=</span> dust2<span class="op">::</span>r<span class="op">::</span>read_real<span class="op">(</span>pars<span class="op">,</span> <span class="st">"tau"</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb2-40"><a href="#cb2-40" tabindex="-1"></a>    <span class="cf">return</span> shared_state<span class="op">{</span>alpha<span class="op">,</span> sigma<span class="op">,</span> gamma<span class="op">,</span> tau<span class="op">};</span></span>
<span id="cb2-41"><a href="#cb2-41" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb2-42"><a href="#cb2-42" tabindex="-1"></a></span>
<span id="cb2-43"><a href="#cb2-43" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">void</span> update_shared<span class="op">(</span>cpp11<span class="op">::</span>list pars<span class="op">,</span> shared_state<span class="op">&amp;</span> shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-44"><a href="#cb2-44" tabindex="-1"></a>    shared<span class="op">.</span>alpha <span class="op">=</span> dust2<span class="op">::</span>r<span class="op">::</span>read_real<span class="op">(</span>pars<span class="op">,</span> <span class="st">"alpha"</span><span class="op">,</span> shared<span class="op">.</span>alpha<span class="op">);</span></span>
<span id="cb2-45"><a href="#cb2-45" tabindex="-1"></a>    shared<span class="op">.</span>sigma <span class="op">=</span> dust2<span class="op">::</span>r<span class="op">::</span>read_real<span class="op">(</span>pars<span class="op">,</span> <span class="st">"sigma"</span><span class="op">,</span> shared<span class="op">.</span>sigma<span class="op">);</span></span>
<span id="cb2-46"><a href="#cb2-46" tabindex="-1"></a>    shared<span class="op">.</span>gamma <span class="op">=</span> dust2<span class="op">::</span>r<span class="op">::</span>read_real<span class="op">(</span>pars<span class="op">,</span> <span class="st">"gamma"</span><span class="op">,</span> shared<span class="op">.</span>gamma<span class="op">);</span></span>
<span id="cb2-47"><a href="#cb2-47" tabindex="-1"></a>    shared<span class="op">.</span>tau <span class="op">=</span> dust2<span class="op">::</span>r<span class="op">::</span>read_real<span class="op">(</span>pars<span class="op">,</span> <span class="st">"tau"</span><span class="op">,</span> shared<span class="op">.</span>tau<span class="op">);</span></span>
<span id="cb2-48"><a href="#cb2-48" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb2-49"><a href="#cb2-49" tabindex="-1"></a></span>
<span id="cb2-50"><a href="#cb2-50" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">data_type</span> build_data<span class="op">(</span>cpp11<span class="op">::</span>list r_data<span class="op">,</span> <span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-51"><a href="#cb2-51" tabindex="-1"></a>    <span class="kw">auto</span> data <span class="op">=</span> <span class="kw">static_cast</span><span class="op">&lt;</span>cpp11<span class="op">::</span>list<span class="op">&gt;(</span>r_data<span class="op">);</span></span>
<span id="cb2-52"><a href="#cb2-52" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> observed <span class="op">=</span> dust2<span class="op">::</span>r<span class="op">::</span>read_real<span class="op">(</span>data<span class="op">,</span> <span class="st">"observed"</span><span class="op">,</span> NA_REAL<span class="op">);</span></span>
<span id="cb2-53"><a href="#cb2-53" tabindex="-1"></a>    <span class="cf">return</span> <span class="dt">data_type</span><span class="op">{</span>observed<span class="op">};</span></span>
<span id="cb2-54"><a href="#cb2-54" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb2-55"><a href="#cb2-55" tabindex="-1"></a></span>
<span id="cb2-56"><a href="#cb2-56" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">void</span> initial<span class="op">(</span><span class="dt">real_type</span> time<span class="op">,</span></span>
<span id="cb2-57"><a href="#cb2-57" tabindex="-1"></a>                      <span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">,</span></span>
<span id="cb2-58"><a href="#cb2-58" tabindex="-1"></a>                      internal_state<span class="op">&amp;</span> internal<span class="op">,</span></span>
<span id="cb2-59"><a href="#cb2-59" tabindex="-1"></a>                      <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">,</span></span>
<span id="cb2-60"><a href="#cb2-60" tabindex="-1"></a>                      <span class="dt">real_type</span> <span class="op">*</span> state_next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-61"><a href="#cb2-61" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> monty<span class="op">::</span>random<span class="op">::</span>normal<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>rng_state<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb2-62"><a href="#cb2-62" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb2-63"><a href="#cb2-63" tabindex="-1"></a></span>
<span id="cb2-64"><a href="#cb2-64" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">void</span> update<span class="op">(</span><span class="dt">real_type</span> time<span class="op">,</span></span>
<span id="cb2-65"><a href="#cb2-65" tabindex="-1"></a>                     <span class="dt">real_type</span> dt<span class="op">,</span></span>
<span id="cb2-66"><a href="#cb2-66" tabindex="-1"></a>                     <span class="at">const</span> <span class="dt">real_type</span> <span class="op">*</span> state<span class="op">,</span></span>
<span id="cb2-67"><a href="#cb2-67" tabindex="-1"></a>                     <span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">,</span></span>
<span id="cb2-68"><a href="#cb2-68" tabindex="-1"></a>                     internal_state<span class="op">&amp;</span> internal<span class="op">,</span></span>
<span id="cb2-69"><a href="#cb2-69" tabindex="-1"></a>                     <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">,</span></span>
<span id="cb2-70"><a href="#cb2-70" tabindex="-1"></a>                     <span class="dt">real_type</span> <span class="op">*</span> state_next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-71"><a href="#cb2-71" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> x <span class="op">=</span> state<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb2-72"><a href="#cb2-72" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> shared<span class="op">.</span>alpha <span class="op">*</span> x <span class="op">+</span></span>
<span id="cb2-73"><a href="#cb2-73" tabindex="-1"></a>      shared<span class="op">.</span>sigma <span class="op">*</span> monty<span class="op">::</span>random<span class="op">::</span>normal<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>rng_state<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb2-74"><a href="#cb2-74" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb2-75"><a href="#cb2-75" tabindex="-1"></a></span>
<span id="cb2-76"><a href="#cb2-76" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">real_type</span> compare_data<span class="op">(</span><span class="at">const</span> <span class="dt">real_type</span> time<span class="op">,</span></span>
<span id="cb2-77"><a href="#cb2-77" tabindex="-1"></a>                                <span class="at">const</span> <span class="dt">real_type</span> <span class="op">*</span> state<span class="op">,</span></span>
<span id="cb2-78"><a href="#cb2-78" tabindex="-1"></a>                                <span class="at">const</span> <span class="dt">data_type</span><span class="op">&amp;</span> data<span class="op">,</span></span>
<span id="cb2-79"><a href="#cb2-79" tabindex="-1"></a>                                <span class="at">const</span> shared_state<span class="op">&amp;</span> shared<span class="op">,</span></span>
<span id="cb2-80"><a href="#cb2-80" tabindex="-1"></a>                                internal_state<span class="op">&amp;</span> internal<span class="op">,</span></span>
<span id="cb2-81"><a href="#cb2-81" tabindex="-1"></a>                                <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-82"><a href="#cb2-82" tabindex="-1"></a>    <span class="at">const</span> <span class="kw">auto</span> x <span class="op">=</span> state<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb2-83"><a href="#cb2-83" tabindex="-1"></a>    <span class="cf">return</span> monty<span class="op">::</span>density<span class="op">::</span>normal<span class="op">(</span>data<span class="op">.</span>observed<span class="op">,</span> shared<span class="op">.</span>gamma <span class="op">*</span> x<span class="op">,</span> shared<span class="op">.</span>tau<span class="op">,</span></span>
<span id="cb2-84"><a href="#cb2-84" tabindex="-1"></a>                                  <span class="kw">true</span><span class="op">);</span></span>
<span id="cb2-85"><a href="#cb2-85" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb2-86"><a href="#cb2-86" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">volatility</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dust_compile.html">dust_compile</a></span><span class="op">(</span><span class="st">"examples/volatility.cpp"</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>To demonstrate the approach, we simulate some data from the model
itself. We have to include the simulation of the observation process
here which adds an additional sample from the normal distribution.</p>
<p>These are the parameters we will use:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="co"># Generation process</span></span>
<span>  alpha <span class="op">=</span> <span class="fl">0.91</span>,</span>
<span>  sigma <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  <span class="co"># Observation process</span></span>
<span>  gamma <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  tau <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">local</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">sys</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dust_system_create.html">dust_system_create</a></span><span class="op">(</span><span class="va">volatility</span>, <span class="va">pars</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/dust_system_set_state_initial.html">dust_system_set_state_initial</a></span><span class="op">(</span><span class="va">sys</span><span class="op">)</span></span>
<span>  <span class="va">times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">100</span>, by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/drop.html" class="external-link">drop</a></span><span class="op">(</span><span class="fu"><a href="../reference/dust_system_simulate.html">dust_system_simulate</a></span><span class="op">(</span><span class="va">sys</span>, <span class="va">times</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">times</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">times</span>, observed <span class="op">=</span> <span class="va">observed</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt;   time   observed</span></span>
<span><span class="co">#&gt; 1    1 -1.1184632</span></span>
<span><span class="co">#&gt; 2    2  1.0098167</span></span>
<span><span class="co">#&gt; 3    3  0.4216554</span></span>
<span><span class="co">#&gt; 4    4 -1.1422005</span></span>
<span><span class="co">#&gt; 5    5 -3.2172936</span></span>
<span><span class="co">#&gt; 6    6 -2.4180258</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">observed</span> <span class="op">~</span> <span class="va">time</span>, <span class="va">data</span>, type <span class="op">=</span> <span class="st">"o"</span>, pch <span class="op">=</span> <span class="fl">19</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="data_files/figure-html/unnamed-chunk-6-1.png" width="672"></p>
<p>Now, we construct a particle filter:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">filter</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dust_filter_create.html">dust_filter_create</a></span><span class="op">(</span><span class="va">volatility</span>, <span class="fl">0</span>, <span class="va">data</span>, n_particles <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="va">filter</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">&lt;dust_likelihood (volatility)&gt;</span> <span style="color: #00BBBB;">──────────────────────────────────────────────</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> 1000 particles</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> The likelihood is stochastic</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> This system runs in discrete time with dt = 1</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Use coef() (`?stats::coef()`) to get more information on parameters</span></span></code></pre></div>
<p>Running the particle filter simulates the process on all
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mn>10</mn><mn>3</mn></msup><annotation encoding="application/x-tex">10^3</annotation></semantics></math>
particles and compares at each timestep the simulated data with your
observed data using the provided comparison function. It returns the
log-likelihood:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dust_likelihood_run.html">dust_likelihood_run</a></span><span class="op">(</span><span class="va">filter</span>, <span class="va">pars</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -175.962</span></span></code></pre></div>
<p>This is stochastic and each time you run it, the estimate will
differ:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dust_likelihood_run.html">dust_likelihood_run</a></span><span class="op">(</span><span class="va">filter</span>, <span class="va">pars</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -175.9821</span></span></code></pre></div>
<p>In this case the model is simple enough that we can use a <a href="https://en.wikipedia.org/wiki/Kalman_filter" class="external-link">Kalman Filter</a> to
calculate the likelihood exactly:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">kalman_filter</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pars</span>, <span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">observed</span></span>
<span></span>
<span>  <span class="va">mu</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">s</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>  <span class="va">log_likelihood</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">mu</span> <span class="op">&lt;-</span> <span class="va">pars</span><span class="op">$</span><span class="va">alpha</span> <span class="op">*</span> <span class="va">mu</span></span>
<span>    <span class="va">s</span> <span class="op">&lt;-</span> <span class="va">pars</span><span class="op">$</span><span class="va">alpha</span><span class="op">^</span><span class="fl">2</span> <span class="op">*</span> <span class="va">s</span> <span class="op">+</span> <span class="va">pars</span><span class="op">$</span><span class="va">sigma</span><span class="op">^</span><span class="fl">2</span></span>
<span>    <span class="va">m</span> <span class="op">&lt;-</span> <span class="va">pars</span><span class="op">$</span><span class="va">gamma</span> <span class="op">*</span> <span class="va">mu</span></span>
<span></span>
<span>    <span class="va">S</span> <span class="op">&lt;-</span> <span class="va">pars</span><span class="op">$</span><span class="va">gamma</span><span class="op">^</span><span class="fl">2</span> <span class="op">*</span> <span class="va">s</span> <span class="op">+</span> <span class="va">pars</span><span class="op">$</span><span class="va">tau</span><span class="op">^</span><span class="fl">2</span></span>
<span>    <span class="va">K</span> <span class="op">&lt;-</span> <span class="va">pars</span><span class="op">$</span><span class="va">gamma</span> <span class="op">*</span> <span class="va">s</span> <span class="op">/</span> <span class="va">S</span></span>
<span></span>
<span>    <span class="va">mu</span> <span class="op">&lt;-</span> <span class="va">mu</span> <span class="op">+</span> <span class="va">K</span> <span class="op">*</span> <span class="op">(</span><span class="va">y</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">-</span> <span class="va">m</span><span class="op">)</span></span>
<span>    <span class="va">s</span> <span class="op">&lt;-</span> <span class="va">s</span> <span class="op">-</span> <span class="va">pars</span><span class="op">$</span><span class="va">gamma</span> <span class="op">*</span> <span class="va">K</span> <span class="op">*</span> <span class="va">s</span></span>
<span></span>
<span>    <span class="va">log_likelihood</span> <span class="op">&lt;-</span> <span class="va">log_likelihood</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">y</span><span class="op">[</span><span class="va">t</span><span class="op">]</span>, <span class="va">m</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">log_likelihood</span></span>
<span><span class="op">}</span></span>
<span><span class="va">ll_k</span> <span class="op">&lt;-</span> <span class="fu">kalman_filter</span><span class="op">(</span><span class="va">pars</span>, <span class="va">data</span><span class="op">)</span></span>
<span><span class="va">ll_k</span></span>
<span><span class="co">#&gt; [1] -175.9048</span></span></code></pre></div>
<p>Unlike the particle filter the Kalman filter is deterministic:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">kalman_filter</span><span class="op">(</span><span class="va">pars</span>, <span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -175.9048</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ll</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="fl">200</span>, <span class="fu"><a href="../reference/dust_likelihood_run.html">dust_likelihood_run</a></span><span class="op">(</span><span class="va">filter</span>, <span class="va">pars</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">ll</span>, col <span class="op">=</span> <span class="st">"steelblue3"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="va">ll_k</span>, col <span class="op">=</span> <span class="st">"red"</span>, lty <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="data_files/figure-html/unnamed-chunk-11-1.png" width="672"></p>
<p>As the number of particles used changes, the variance of this
estimate will change. For example, here is a filter with only 100
particles (1/10th the number as in the previous). We plot the range of
observed likelihoods from the larger filter as orange vertical
lines.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">filter2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dust_filter_create.html">dust_filter_create</a></span><span class="op">(</span><span class="va">volatility</span>, <span class="fl">0</span>, <span class="va">data</span>, n_particles <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">ll2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="fl">200</span>, <span class="fu"><a href="../reference/dust_likelihood_run.html">dust_likelihood_run</a></span><span class="op">(</span><span class="va">filter2</span>, <span class="va">pars</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">ll2</span>, col <span class="op">=</span> <span class="st">"steelblue3"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="va">ll_k</span>, col <span class="op">=</span> <span class="st">"red"</span>, lty <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">ll</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"orange"</span>, lty <span class="op">=</span> <span class="fl">3</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="data_files/figure-html/unnamed-chunk-12-1.png" width="672"></p>
<p>If you run a particle filter with
<code>save_trajectories = TRUE</code>, it will record the (filtered)
trajectories, which you can then extract with
<code>dust_filter_last_trajectories()</code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dust_likelihood_run.html">dust_likelihood_run</a></span><span class="op">(</span><span class="va">filter</span>, <span class="va">pars</span>, save_trajectories <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -175.9139</span></span>
<span><span class="va">trajectories</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dust_likelihood_last_trajectories.html">dust_likelihood_last_trajectories</a></span><span class="op">(</span><span class="va">filter</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">trajectories</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]    1 1000  100</span></span></code></pre></div>
<p>This is a <code>n_state</code> (here 1) x <code>n_particles</code>
(1000) x <code>n_time</code> (100) 3d array, but we will drop the first
rank of this for plotting, and transpose so that time is the first
axis:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">time</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/drop.html" class="external-link">drop</a></span><span class="op">(</span><span class="va">trajectories</span><span class="op">)</span><span class="op">)</span>, xlab <span class="op">=</span> <span class="st">"Time"</span>, ylab <span class="op">=</span> <span class="st">"Value"</span>,</span>
<span>        las <span class="op">=</span> <span class="fl">1</span>, type <span class="op">=</span> <span class="st">"l"</span>, lty <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="st">"#00000002"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">observed</span> <span class="op">~</span> <span class="va">time</span>, <span class="va">data</span>, col <span class="op">=</span> <span class="st">"red"</span>, pch <span class="op">=</span> <span class="fl">19</span><span class="op">)</span></span></code></pre></div>
<p><img src="data_files/figure-html/unnamed-chunk-14-1.png" width="672"></p>
<p>Here you can see the sampled trajectories fitting the observed data,
with fewer extant trajectories the further back in time you go (fewer,
thicker, lines due to the sampling process).</p>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Rich FitzJohn.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>

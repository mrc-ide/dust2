<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Introduction to dust • dust2</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Introduction to dust">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">dust2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.28</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/dust2.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/design.html">Principles and design of dust</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Details</h6></li>
    <li><a class="dropdown-item" href="../articles/data.html">Comparing dust systems to data</a></li>
    <li><a class="dropdown-item" href="../articles/details.html">Details</a></li>
    <li><a class="dropdown-item" href="../articles/packaging.html">Packaging dust systems</a></li>
    <li><a class="dropdown-item" href="../articles/periodic.html">Periodic variables details</a></li>
    <li><a class="dropdown-item" href="../articles/writing.html">Writing dust2 systems</a></li>
    <li><a class="dropdown-item" href="../articles/migrating.html">Migrating from dust 1.x.x</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mrc-ide/dust2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Introduction to dust</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/dust2/blob/main/vignettes/dust2.Rmd" class="external-link"><code>vignettes/dust2.Rmd</code></a></small>
      <div class="d-none name"><code>dust2.Rmd</code></div>
    </div>

    
    
<p>Stochastic models can be used in statistical inference via methods
such as <a href="https://en.wikipedia.org/wiki/Particle_filter" class="external-link">particle
filtering</a> but in practice doing so requires that the models can be
run over and over again very quickly. While R has excellent support for
sampling from distributions, it is not necessarily well suited for this
sort of problem because R is single threaded, so we are forced to
evaluate realisations of the stochastic process in series (one after
another) rather than in parallel.</p>
<p>The <code>dust2</code> package provides tools to help write
stochastic models that can be evaluated in parallel. It does not
directly provide statistical methods; see the <a href="https://mrc-ide.github.io/mcstate/" class="external-link">monty</a> package for that.
Instead, it focuses on providing:</p>
<ul>
<li>a way of wrapping a user-provided model, itself written as a C++
class</li>
<li>a lightweight interface that drives this model from R</li>
<li>a set of useful primitives for developing sequential Monte Carlo
methods.</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mrc-ide/dust2" class="external-link">dust2</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="a-simple-example---random-walk">A simple example - random walk<a class="anchor" aria-label="anchor" href="#a-simple-example---random-walk"></a>
</h2>
<p>Consider a unbiased random walk; at each time step we move our
position with a draw from a normal distribution with mean 0 and some
standard deviation. We consider a single individual moving but will
eventually simulate a family of these individuals, each independent. All
simulations have a sense of time - a unitless measure of time “step”
will be used but it’s up to you how it is interpreted (time is a
non-negative integer, implemented using <code>size_t</code>).</p>
<p>In this example, we’ll use the built-in example from the package:</p>
<p>However, this is also bundled into the package and can be loaded
with:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">walk</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dust_example.html">dust_example</a></span><span class="op">(</span><span class="st">"walk"</span><span class="op">)</span></span></code></pre></div>
<p><code>walk</code> is a <code>dust_system_generator</code> object:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">walk</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">&lt;dust_system_generator: walk&gt;</span> <span style="color: #00BBBB;">───────────────────────────────────────────────</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> This system runs in discrete time with a default dt of 1</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> This system has 3 parameters</span></span>
<span><span class="co">#&gt; → 'sd', 'len', and 'random_initial'</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Use dust2::dust_system_create() (`?dust2::dust_system_create()`) to create a system with this generator</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Use coef() (`?stats::coef()`) to get more information on parameters</span></span></code></pre></div>
<p>Create an instance of the system using
<code><a href="../reference/dust_system_create.html">dust_system_create()</a></code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sys</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dust_system_create.html">dust_system_create</a></span><span class="op">(</span><span class="va">walk</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, n_particles <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">sys</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">&lt;dust_system: walk&gt;</span> <span style="color: #00BBBB;">─────────────────────────────────────────────────────────</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> 1 state x 20 particles</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> This system runs in discrete time with dt = 1</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> This system has 1 parameter that can be updated via `dust_system_update_pars`</span></span>
<span><span class="co">#&gt; → 'sd'</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Use coef() (`?stats::coef()`) to get more information on parameters</span></span></code></pre></div>
<p>This returns a <code>dust_system</code> object that can be used to
simulate from or interact with the system. For example, our initial
model state is</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dust_system_state.html">dust_system_state</a></span><span class="op">(</span><span class="va">sys</span><span class="op">)</span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13] [,14]</span></span>
<span><span class="co">#&gt; [1,]    0    0    0    0    0    0    0    0    0     0     0     0     0     0</span></span>
<span><span class="co">#&gt;      [,15] [,16] [,17] [,18] [,19] [,20]</span></span>
<span><span class="co">#&gt; [1,]     0     0     0     0     0     0</span></span></code></pre></div>
<p>Here there is one row per model state variable (there is only one
here) and one column per particle (there are 20). All systems start with
a zero state unless you set them via
<code><a href="../reference/dust_system_set_state.html">dust_system_set_state()</a></code>,
<code><a href="../reference/dust_system_set_state_initial.html">dust_system_set_state_initial()</a></code> or by running the
system.</p>
<p>We can run the system for 100 time steps, then return the state at
the end of the walk (and not at any intermediate times):</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dust_system_run_to_time.html">dust_system_run_to_time</a></span><span class="op">(</span><span class="va">sys</span>, <span class="fl">100</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/dust_system_state.html">dust_system_state</a></span><span class="op">(</span><span class="va">sys</span><span class="op">)</span></span>
<span><span class="co">#&gt;           [,1]       [,2]     [,3]     [,4]     [,5]      [,6]     [,7]</span></span>
<span><span class="co">#&gt; [1,] -2.069917 -0.9781523 8.965475 5.710992 17.03536 -4.266331 6.208208</span></span>
<span><span class="co">#&gt;          [,8]      [,9]     [,10]     [,11]    [,12]     [,13]     [,14]</span></span>
<span><span class="co">#&gt; [1,] 1.202825 -20.75184 -6.728591 0.2456902 7.762512 -7.534014 -4.132089</span></span>
<span><span class="co">#&gt;          [,15]     [,16]    [,17]     [,18]    [,19]     [,20]</span></span>
<span><span class="co">#&gt; [1,] -5.865048 -16.15312 23.93168 -18.12983 3.208677 -1.279874</span></span></code></pre></div>
<p>At this point our particles have been run for 100 time steps with
standard deviation 1 at each step so they <a href="https://en.wikipedia.org/wiki/Random_walk#Gaussian_random_walk" class="external-link">will
be distributed following Normal(0, 10)</a>. This is easier to see if we
simulate a lot of particles, here 20,000:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sys</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dust_system_create.html">dust_system_create</a></span><span class="op">(</span><span class="va">walk</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, n_particles <span class="op">=</span> <span class="fl">20000</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/dust_system_run_to_time.html">dust_system_run_to_time</a></span><span class="op">(</span><span class="va">sys</span>, <span class="fl">100</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="fu"><a href="../reference/dust_system_state.html">dust_system_state</a></span><span class="op">(</span><span class="va">sys</span><span class="op">)</span>, freq <span class="op">=</span> <span class="cn">FALSE</span>, las <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="st">"steelblue2"</span>, main <span class="op">=</span> <span class="st">""</span>,</span>
<span>     ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.</span>, <span class="fl">0.04</span><span class="op">)</span>, xlab <span class="op">=</span> <span class="st">"State"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/curve.html" class="external-link">curve</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"orange"</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="dust2_files/figure-html/walk_simulate_many-1.png" width="672"></p>
<div class="section level3">
<h3 id="running-a-model-in-parallel">Running a model in parallel<a class="anchor" aria-label="anchor" href="#running-a-model-in-parallel"></a>
</h3>
<p>The approach above still runs everything in serial, one particle
after another. We can configure this system to run in parallel by
providing the extra argument <code>n_threads</code> to the
constructor.</p>
<p>Provided that your computer can compile with OpenMP the following
code will execute in parallel using 2 threads</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sys</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dust_system_create.html">dust_system_create</a></span><span class="op">(</span><span class="va">walk</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, n_particles <span class="op">=</span> <span class="fl">20</span>, n_threads <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/dust_system_run_to_time.html">dust_system_run_to_time</a></span><span class="op">(</span><span class="va">sys</span>, <span class="fl">100</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/dust_system_state.html">dust_system_state</a></span><span class="op">(</span><span class="va">sys</span><span class="op">)</span></span>
<span><span class="co">#&gt;           [,1]      [,2]      [,3]     [,4]     [,5]     [,6]      [,7]</span></span>
<span><span class="co">#&gt; [1,] -7.798794 -4.706807 -6.580274 12.30675 10.50923 9.982649 -9.252921</span></span>
<span><span class="co">#&gt;          [,8]    [,9]    [,10]     [,11]    [,12]     [,13]    [,14]     [,15]</span></span>
<span><span class="co">#&gt; [1,] 3.452613 4.99186 6.299646 -5.948605 8.729621 -7.338344 8.081076 0.1275727</span></span>
<span><span class="co">#&gt;         [,16]    [,17]     [,18]     [,19]     [,20]</span></span>
<span><span class="co">#&gt; [1,] 8.244453 6.885286 -9.878333 -11.25054 -3.151811</span></span></code></pre></div>
<p>We use as many random number generators as there are particles, so if
you run fewer particles or more, increase the threads or decrease, the
results will be the same (see <code><a href="../articles/design.html">vignette("design")</a></code> for more
on this).</p>
<p>You should be careful when selecting the number of threads.
<code>dust</code> will never use more than one thread at a time without
it being requested, but avoid using <code><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">parallel::detectCores()</a></code>
to work out how many threads you have available as it will often return
an overestimate. This is particularly the case in a shared-use system
such as a cluster or CRAN’s servers.</p>
</div>
</div>
<div class="section level2">
<h2 id="a-more-interesting-example">A more interesting example<a class="anchor" aria-label="anchor" href="#a-more-interesting-example"></a>
</h2>
<p>Consider now an SIR model (Susceptible - Infected - Recovered). This
sort of model is common in epidemiology, and is often extended to add
additional compartments (e.g., SEIR which adds an Exposed compartment)
or by structuring each compartment based on properties such as age.
Here, we show a simple example with just 3 compartments, plus two
tracking cumulative infections and daily infections.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dust_example.html">dust_example</a></span><span class="op">(</span><span class="st">"sir"</span><span class="op">)</span></span></code></pre></div>
<p>The model is initialised the same way as before:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sys</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dust_system_create.html">dust_system_create</a></span><span class="op">(</span><span class="va">sir</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>, n_particles <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>This system has a non-trivial initial state; we can set it with
<code><a href="../reference/dust_system_set_state_initial.html">dust_system_set_state_initial()</a></code>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dust_system_state.html">dust_system_state</a></span><span class="op">(</span><span class="va">sys</span><span class="op">)</span></span>
<span><span class="co">#&gt;      [,1] [,2]</span></span>
<span><span class="co">#&gt; [1,]    0    0</span></span>
<span><span class="co">#&gt; [2,]    0    0</span></span>
<span><span class="co">#&gt; [3,]    0    0</span></span>
<span><span class="co">#&gt; [4,]    0    0</span></span>
<span><span class="co">#&gt; [5,]    0    0</span></span>
<span><span class="fu"><a href="../reference/dust_system_set_state_initial.html">dust_system_set_state_initial</a></span><span class="op">(</span><span class="va">sys</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/dust_system_state.html">dust_system_state</a></span><span class="op">(</span><span class="va">sys</span><span class="op">)</span></span>
<span><span class="co">#&gt;      [,1] [,2]</span></span>
<span><span class="co">#&gt; [1,]  990  990</span></span>
<span><span class="co">#&gt; [2,]   10   10</span></span>
<span><span class="co">#&gt; [3,]    0    0</span></span>
<span><span class="co">#&gt; [4,]    0    0</span></span>
<span><span class="co">#&gt; [5,]    0    0</span></span></code></pre></div>
<p>Because we have 5 states per particle, this is a 5 x 2 matrix.</p>
<p>In order to run the simulation beginning-to-end, we use the
<code>$simulate</code> method on a dust object, which runs over a set of
time steps and records the state at each. Let’s do this with 200
particles:x</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sys</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dust_system_create.html">dust_system_create</a></span><span class="op">(</span><span class="va">sir</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>, n_particles <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/dust_system_set_state_initial.html">dust_system_set_state_initial</a></span><span class="op">(</span><span class="va">sys</span><span class="op">)</span></span>
<span><span class="va">times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">150</span><span class="op">)</span></span>
<span><span class="va">state</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dust_system_simulate.html">dust_system_simulate</a></span><span class="op">(</span><span class="va">sys</span>, <span class="va">times</span><span class="op">)</span></span></code></pre></div>
<p>The output here is a 5 x 200 x 151 matrix (n state x n particles x n
times)</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]   5 200 151</span></span></code></pre></div>
<p>We can use <code>dust_unpack_state</code> to convert this into a
list-of-matrices:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">state</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dust_unpack.html">dust_unpack_state</a></span><span class="op">(</span><span class="va">sys</span>, <span class="va">state</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "S"           "I"           "R"           "cases_cumul" "cases_inc"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">state</span><span class="op">$</span><span class="va">cases_inc</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 200 151</span></span></code></pre></div>
<p>so here <code>state$cases_inc</code> is a 200 (particle) by 151 (time
step) matrix. Note that this will need transposing before plotting.</p>
<p>Plotting this over time, we see:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span><span class="va">times</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">state</span><span class="op">$</span><span class="va">I</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"l"</span>, lty <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="st">"#00000022"</span>,</span>
<span>        xlab <span class="op">=</span> <span class="st">"Time"</span>, ylab <span class="op">=</span> <span class="st">"Number infected (I)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">times</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">state</span><span class="op">$</span><span class="va">I</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="dust2_files/figure-html/sir_average-1.png" width="672"></p>
</div>
<div class="section level2">
<h2 id="other-methods">Other methods<a class="anchor" aria-label="anchor" href="#other-methods"></a>
</h2>
<p>There are a few other methods on the dust objects that may be
useful.</p>
<div class="section level3">
<h3 id="reordering-particles">Reordering particles<a class="anchor" aria-label="anchor" href="#reordering-particles"></a>
</h3>
<p>This method exists to support particle filtering, and allows
resampling or reordering of particles.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sys</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dust_system_create.html">dust_system_create</a></span><span class="op">(</span><span class="va">walk</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, n_particles <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/dust_system_run_to_time.html">dust_system_run_to_time</a></span><span class="op">(</span><span class="va">sys</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/dust_system_state.html">dust_system_state</a></span><span class="op">(</span><span class="va">sys</span><span class="op">)</span></span>
<span><span class="co">#&gt;           [,1]     [,2]       [,3]     [,4]      [,5]     [,6]      [,7]</span></span>
<span><span class="co">#&gt; [1,] 0.4197933 0.250539 0.01482815 1.448195 0.5231619 0.820422 0.2495565</span></span>
<span><span class="co">#&gt;            [,8]      [,9]  [,10]    [,11]     [,12]      [,13]      [,14]</span></span>
<span><span class="co">#&gt; [1,] -0.3809611 0.3352818 1.9442 0.229384 -1.492759 -0.1146346 -0.3091399</span></span>
<span><span class="co">#&gt;          [,15]      [,16]     [,17]     [,18]      [,19]      [,20]</span></span>
<span><span class="co">#&gt; [1,] 0.4338285 -0.1675469 0.7650757 -1.294391 -0.6569056 -0.5690646</span></span></code></pre></div>
<p>Suppose that we wanted to reorder these particles so that they were
in decreasing order:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="fu"><a href="../reference/dust_system_state.html">dust_system_state</a></span><span class="op">(</span><span class="va">sys</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">index</span></span>
<span><span class="co">#&gt;  [1] 12 18 19 20  8 14 16 13  3 11  7  2  9  1 15  5 17  6  4 10</span></span></code></pre></div>
<p>We then pass this <code>index</code> to the reorder method:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dust_system_reorder.html">dust_system_reorder</a></span><span class="op">(</span><span class="va">sys</span>, <span class="va">index</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/dust_system_state.html">dust_system_state</a></span><span class="op">(</span><span class="va">sys</span><span class="op">)</span></span>
<span><span class="co">#&gt;           [,1]      [,2]       [,3]       [,4]       [,5]       [,6]       [,7]</span></span>
<span><span class="co">#&gt; [1,] -1.492759 -1.294391 -0.6569056 -0.5690646 -0.3809611 -0.3091399 -0.1675469</span></span>
<span><span class="co">#&gt;            [,8]       [,9]    [,10]     [,11]    [,12]     [,13]     [,14]</span></span>
<span><span class="co">#&gt; [1,] -0.1146346 0.01482815 0.229384 0.2495565 0.250539 0.3352818 0.4197933</span></span>
<span><span class="co">#&gt;          [,15]     [,16]     [,17]    [,18]    [,19]  [,20]</span></span>
<span><span class="co">#&gt; [1,] 0.4338285 0.5231619 0.7650757 0.820422 1.448195 1.9442</span></span></code></pre></div>
<p>We can then continue our random walk. There is no need to sample
every particle and particles can appear multiple times in the sample,
but the total number must be conserved. Suppose that we want to sample
particles based on how close they are to 0:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fu"><a href="../reference/dust_system_state.html">dust_system_state</a></span><span class="op">(</span><span class="va">sys</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span> , prob <span class="op">=</span> <span class="va">p</span><span class="op">)</span></span>
<span><span class="va">index</span></span>
<span><span class="co">#&gt;  [1]  2 15 15  9 10  7 16  6  4  5 16 20  6  3  2 10 15  8 11  6</span></span></code></pre></div>
<p>We can then apply this sampling:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dust_system_reorder.html">dust_system_reorder</a></span><span class="op">(</span><span class="va">sys</span>, <span class="va">index</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/dust_system_state.html">dust_system_state</a></span><span class="op">(</span><span class="va">sys</span><span class="op">)</span></span>
<span><span class="co">#&gt;           [,1]      [,2]      [,3]       [,4]     [,5]       [,6]      [,7]</span></span>
<span><span class="co">#&gt; [1,] -1.294391 0.4338285 0.4338285 0.01482815 0.229384 -0.1675469 0.5231619</span></span>
<span><span class="co">#&gt;            [,8]       [,9]      [,10]     [,11]  [,12]      [,13]      [,14]</span></span>
<span><span class="co">#&gt; [1,] -0.3091399 -0.5690646 -0.3809611 0.5231619 1.9442 -0.3091399 -0.6569056</span></span>
<span><span class="co">#&gt;          [,15]    [,16]     [,17]      [,18]     [,19]      [,20]</span></span>
<span><span class="co">#&gt; [1,] -1.294391 0.229384 0.4338285 -0.1146346 0.2495565 -0.3091399</span></span></code></pre></div>
<p>This is not terribly useful on its own but is a key part of a
particle filter.</p>
<p>When this reordering happens, only the model state is copied around;
the <code>internal</code> data and random number state are left
behind.</p>
</div>
<div class="section level3">
<h3 id="set-particle-state">Set particle state<a class="anchor" aria-label="anchor" href="#set-particle-state"></a>
</h3>
<p>A particle state is determined by three mutable things;
<code>pars</code>, <code>state</code> and <code>time</code>; these can
all be updated for a model after it has been created. We have found
setting one or more of these at a time important;</p>
<ul>
<li>Resetting the model with a new set of parameters
(<code>pars</code>), initial conditions (<code>state</code>) and times
(<code>time</code>)</li>
<li>Changing <code>pars</code> at some point in the simulation to
introduce some new aspect of the model</li>
<li>Changing <code>state</code> to manually move around some individuals
within a model</li>
<li>Setting <code>time</code> along with <code>state</code> when
initialising the model from a previously saved state</li>
</ul>
<p>The <code>update_state</code> method allows setting any or all of
these components.</p>
<p>By default every particle starts from the initial condition specified
by your model classes <code>initial()</code> method. However, you can
specify a state directly using the <code>$update_state()</code> method.
Here, we initialise our SIR model with only 1 infected individual rather
than 10:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sys</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dust_system_create.html">dust_system_create</a></span><span class="op">(</span><span class="va">sir</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>, n_particles <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/dust_system_set_state.html">dust_system_set_state</a></span><span class="op">(</span><span class="va">sys</span>, <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, <span class="fl">5</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/dust_system_state.html">dust_system_state</a></span><span class="op">(</span><span class="va">sys</span><span class="op">)</span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13] [,14]</span></span>
<span><span class="co">#&gt; [1,] 1000 1000 1000 1000 1000 1000 1000 1000 1000  1000  1000  1000  1000  1000</span></span>
<span><span class="co">#&gt; [2,]    1    1    1    1    1    1    1    1    1     1     1     1     1     1</span></span>
<span><span class="co">#&gt; [3,]    0    0    0    0    0    0    0    0    0     0     0     0     0     0</span></span>
<span><span class="co">#&gt; [4,]    0    0    0    0    0    0    0    0    0     0     0     0     0     0</span></span>
<span><span class="co">#&gt; [5,]    0    0    0    0    0    0    0    0    0     0     0     0     0     0</span></span>
<span><span class="co">#&gt;      [,15] [,16] [,17] [,18] [,19] [,20]</span></span>
<span><span class="co">#&gt; [1,]  1000  1000  1000  1000  1000  1000</span></span>
<span><span class="co">#&gt; [2,]     1     1     1     1     1     1</span></span>
<span><span class="co">#&gt; [3,]     0     0     0     0     0     0</span></span>
<span><span class="co">#&gt; [4,]     0     0     0     0     0     0</span></span>
<span><span class="co">#&gt; [5,]     0     0     0     0     0     0</span></span></code></pre></div>
<p>Now, when we run the model, far more of the epidemics fail to take
off as the infected individual disappears before infecting anyone.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">state</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dust_system_simulate.html">dust_system_simulate</a></span><span class="op">(</span><span class="va">sys</span>, <span class="va">times</span><span class="op">)</span></span>
<span><span class="va">state</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dust_unpack.html">dust_unpack_state</a></span><span class="op">(</span><span class="va">sys</span>, <span class="va">state</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span><span class="va">times</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">state</span><span class="op">$</span><span class="va">I</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"l"</span>, lty <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="st">"#00000022"</span>,</span>
<span>        xlab <span class="op">=</span> <span class="st">"Day"</span>, ylab <span class="op">=</span> <span class="st">"Number infected (I)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="dust2_files/figure-html/unnamed-chunk-4-1.png" width="672"></p>
<p>You can optionally set the initial time along with the state. This is
useful if your model depends on time (e.g., you use the time step in a
calculation by transforming it into some more meaningful measure of
time).</p>
<p>You can also set the initial state to a range of different values.
Suppose we set the initial number of infections to be Poisson
distributed with a mean of 10, we might write:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">I0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">state0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fl">1010</span> <span class="op">-</span> <span class="va">I0</span>, <span class="va">I0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, deparse.level <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/dust_system_set_state.html">dust_system_set_state</a></span><span class="op">(</span><span class="va">sys</span>, <span class="va">state0</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/dust_system_set_time.html">dust_system_set_time</a></span><span class="op">(</span><span class="va">sys</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/dust_system_time.html">dust_system_time</a></span><span class="op">(</span><span class="va">sys</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="fu"><a href="../reference/dust_system_state.html">dust_system_state</a></span><span class="op">(</span><span class="va">sys</span><span class="op">)</span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13] [,14]</span></span>
<span><span class="co">#&gt; [1,] 1001 1002 1000 1003  998  999  998  998 1000  1007   999   997  1003  1002</span></span>
<span><span class="co">#&gt; [2,]    9    8   10    7   12   11   12   12   10     3    11    13     7     8</span></span>
<span><span class="co">#&gt; [3,]    0    0    0    0    0    0    0    0    0     0     0     0     0     0</span></span>
<span><span class="co">#&gt; [4,]    0    0    0    0    0    0    0    0    0     0     0     0     0     0</span></span>
<span><span class="co">#&gt; [5,]    0    0    0    0    0    0    0    0    0     0     0     0     0     0</span></span>
<span><span class="co">#&gt;      [,15] [,16] [,17] [,18] [,19] [,20]</span></span>
<span><span class="co">#&gt; [1,]   999   996  1001   999  1001  1005</span></span>
<span><span class="co">#&gt; [2,]    11    14     9    11     9     5</span></span>
<span><span class="co">#&gt; [3,]     0     0     0     0     0     0</span></span>
<span><span class="co">#&gt; [4,]     0     0     0     0     0     0</span></span>
<span><span class="co">#&gt; [5,]     0     0     0     0     0     0</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Rich FitzJohn.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
